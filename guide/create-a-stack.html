<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Create a new Muon Stack</title>
  <meta name="description" content="">

    <link rel="stylesheet" href="/css/foundation.css">

    <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <script src="/javascripts/modernizr.foundation.js" type="text/javascript"></script>
    <script src="/javascripts/jquery-2.1.0.js" type="text/javascript"></script>
    <script src="/javascripts/terrific-1.1.1.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.url.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="/javascripts/json2.js" type="text/javascript"></script>
    <script src="/javascripts/foundation.js" type="text/javascript"></script>
  <script>
    // terrificjs bootstrap
    (function($) {
        $(document).ready(function() {
            var $page = $('body');
            var config = {
              dependencyPath: {
                plugin: 'javascripts/'
              }
            }
            var application = new Tc.Application($page, config);
            application.registerModules();
            application.start();
        });
    })(Tc.$);
  </script>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,700,300" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/masonry.pkgd.js" type="text/javascript"></script>
  <script src="/javascripts/imagesloaded.pkgd.min.js" type="text/javascript"></script>
  <script src="/javascripts/slick.min.js" type="text/javascript"></script>

  <link rel="canonical" href="/guide/create-a-stack.html">
  <link rel="alternate" type="application/rss+xml" title="Muon - Reactive APIs" href="/feed.xml" />
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
          <link rel="stylesheet" href="/css/asciidoc.css">
          <link rel="stylesheet" href="/css/producttable.css">
                  <style>
  @media only screen and (min-width:768px){#toctitle{font-size:1.375em}
      body.toc2{padding-left:15em;padding-right:0}
#toc {margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;right:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc >ul{font-size:.9em;margin-bottom:0}
#toc ul ul{margin-left:0;padding-left:1em}
#toc ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
  @media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc {width:20em}
#toc #toctitle{font-size:1.375em}
#toc >ul{font-size:.95em}
#toc ul ul{padding-left:1.25em}
      body.toc2.toc-right{padding-left:0;padding-right:20em}}

#toc { z-index:20; padding-top:120px;}
#documentation { padding-left:10px; margin-left:auto; margin-right:auto}
#documentation .row { margin:auto }
      code {
          background:none;
          border:0;
      }

      code span { border: 0; width:100% }
      .listingblock {
         background: #eee;
         border-radius:5px;
          border:1px solid #ccc
      }
  }

  div.documentation a.btn {
    margin-top:20px;
    background: #3498db;
    background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
    background-image: -moz-linear-gradient(top, #3498db, #2980b9);
    background-image: -ms-linear-gradient(top, #3498db, #2980b9);
    background-image: -o-linear-gradient(top, #3498db, #2980b9);
    background-image: linear-gradient(to bottom, #3498db, #2980b9);
    -webkit-border-radius: 28;
    -moz-border-radius: 28;
    border-radius: 28px;
    font-family: Arial;
    color: #ffffff;
    font-size: 20px;
    padding: 10px 20px 10px 20px;
    text-decoration: none;
  }

  div.documentation a.btn:hover {
    background: #3cb0fd;
    background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
    background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
    text-decoration: none;
  }

  </style>

  <link rel="stylesheet" href="/css/sidebar2.css">
</head>


  <body>
    
      <a id='top'></a>
<div class='contain-to-grid sticky fullwidth'>
  <nav class='top-bar onepage' data-options='sticky_on: large' data-topbar=''>
    <ul class='title-area'>
      <li class='name'>
        <h1>
          <a href="/">
            <img alt="" src="/images/muonlogo.png" style="width:50px; height:50px" /> Muon
          </a>
        </h1>
      </li>
      <li class='toggle-topbar menu-icon'>
        <a href='#'>Menu</a>
      </li>
    </ul>
    <span style="float:left">Reactive APIs for Microservices, Browser and More ...</span>
    <section class='top-bar-section'>
      <ul class='right'>
        
          
            <li>
              
                <a href="/#ce">OSS/ CE</a>
              

            </li>
          
        
          
            <li>
              
                <a href="guide/index.html">Guides</a>
              

            </li>
          
        
          
            <li>
              
                <a href="/pro.html">Pro</a>
              

            </li>
          
        
          
            <li class="has-dropdown">
              <a href="/guide/index.html">Docs</a>
              <ul class='dropdown'>
                
                  <li>
                    <a href="/guide/index.html">Guides</a>
                  </li>
                
                  <li>
                    <a href="/submodules/cli/doc/index.html">CLI</a>
                  </li>
                
                  <li>
                    <a href="/submodules/java/doc/">Java</a>
                  </li>
                
                  <li>
                    <a href="/submodules/clojure/doc/index.html">Clojure</a>
                  </li>
                
                  <li>
                    <a href="/submodules/node/doc/index.html">Node.JS</a>
                  </li>
                
                  <li>
                    <a href="/submodules/muonjs/doc/index.html">Browser</a>
                  </li>
                
                  <li>
                    <a href="/submodules/photon/doc/index.html">Photon - Event Store</a>
                  </li>
                
              </ul>
            </li>
          
        
          
            <li>
              
                <a href="https://github.com/muoncore">Github</a>
              

            </li>
          
        
      </ul>
    </section>
  </nav>
</div>
<div class='full no-padding'>
  <!-- Begin MailChimp Signup Form -->
  <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
         We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
  </style>
  <div id="mc_embed_signup">
    <form action="//simplicityitself.us9.list-manage.com/subscribe/post?u=fce1e12e8f44592cf75288e11&amp;id=98e2ce96d8" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Get updated on new releases and features</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_fce1e12e8f44592cf75288e11_98e2ce96d8" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
      </div>
    </form>
  </div>
</div>

    

    <div id='main' role='main'>
      <div class="documentation">
<div class='full' style='background: #000'>
  <div class='row' style="margin-left:0; margin-right:0; max-width:100%">
    <div class='large-12 columns'>
      <div class='mod modBlogPost big'>
        <div class='images'>
          
        </div>
        <div class='content' style="font-size:1.2rem; max-width:80%">
          <div id="toc" class="toc">
<div id="toctitle">Create a Stack</div>
<ul class="sectlevel1">
<li><a href="#create-a-new-muon-stack">Create a new Muon Stack</a>
<ul class="sectlevel2">
<li><a href="#stack-concepts">Stack Concepts</a></li>
<li><a href="#designing-a-new-stack">Designing a new Stack</a>
<ul class="sectlevel3">
<li><a href="#the-protocol">The Protocol</a></li>
<li><a href="#building-a-client">Building a Client</a>
<ul class="sectlevel4">
<li><a href="#client-api">Client API</a></li>
</ul>
</li>
<li><a href="#building-a-server">Building a Server</a></li>
<li><a href="#building-the-protocol-machines">Building the Protocol Machines</a>
<ul class="sectlevel4">
<li><a href="#java-embedded-protocol">Java embedded protocol</a></li>
<li><a href="#jsprotocol-version">JSProtocol version</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#testing-the-stacks">Testing the Stacks</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="create-a-new-muon-stack">Create a new Muon Stack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Stack is one of the central concepts of Muon, it lets you implement a particular form of communication as a series of messages and do so in a highly portable, straight forward way. As such, it lets you easily implement <em>Reactive</em> architectural principles for Microservices and other types of distributed system (eg, browser/ server etc)</p>
</div>
<div class="paragraph">
<p>A Protocol Stack in Muon defines the message interchange that implements the communication you want (which we call a <em>Protocol</em>) and wraps that in a language idiomatic API to make it easy to use.</p>
</div>
<div class="paragraph">
<p>Generally, a Muon stack is used to implement and encapsulate some technical interactions between 2 to many services rather than trying to implement a business workflow or business process. Examples of these are <a href="https://github.com/muoncore/stack-rpc">RPC</a>, <a href="https://github.com/muoncore/stack-reactive-streams">Reactive Streams</a>, <a href="https://github.com/muoncore/stack-event">Events</a>. If you are looking to map a business process, you may want to look at <a href="http://muoncore.io/submodules/newton/doc/index.html#process-managers-sagas">Newton sagas</a></p>
</div>
<div class="paragraph">
<p>This is not something you would be expected to do every day, rather taking a general pattern of communication you see a lot and distill it into a single stack.</p>
</div>
<div class="sect2">
<h3 id="stack-concepts">Stack Concepts</h3>
<div class="paragraph">
<p>Muon takes the idea of <em>channels</em> and makes them networked. In building a stack, your job is to assemble a set of channels, connect them together and decide what messages should flow over them, in what order, what they mean and what API should be used to interact with them.</p>
</div>
<div class="paragraph">
<p>When building a stack, you are designing both ends of the communication, not just a client or server.</p>
</div>
<div class="paragraph">
<p>Here is a standard stack showing the main components and where they come from.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/stack-overview.png" alt="stack overview">
</div>
<div class="title">Figure 1. Stack Concepts</div>
</div>
<div class="paragraph">
<p>In the above diagram, there are two portions to the stack, the client and the server. The only distinction between them is which initiates the connection between them. After the connection has been created, they are effective peers and can both send and receive messages as wanted, either can end the conversation and close the channel.</p>
</div>
<div class="paragraph">
<p>The APIs are exposed to application code, and so should take into the account the runtime and language that you are targetting. Inside the stack you will be using messaging and channel semantics, if your target developers are used to this you <em>could</em> expose that directly. It is highly unlikely that this is actually what you want however, and so you should design an API that works for your developers and then map that internally onto messages coming from your protocol machines.</p>
</div>
</div>
<div class="sect2">
<h3 id="designing-a-new-stack">Designing a new Stack</h3>
<div class="paragraph">
<p>A stack is a message interchange, a conversation. The first thing you should do then is to design the messages and what they should express in a conversation. A messaging protocol is effectively a Finite State Machine, and so using the design approaches that are valid for FSM design will work well here. Once you have designed the messages, you can code up the Protocol machine to express those, then implement the API to manage the lifecycle of it all.</p>
</div>
<div class="sect3">
<h4 id="the-protocol">The Protocol</h4>
<div class="paragraph">
<p>We will design a full featured protocol to interact with some remote systems. This fictional protocol we will call "continuous function".</p>
</div>
<div class="paragraph">
<p>Protocols in Muon are made up of messages following a standard schema. When passed to a transport, the schema is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript">{
    <span style="color: #BA2121">&quot;target_service&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>,
    <span style="color: #BA2121">&quot;origin_service&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>,
    <span style="color: #BA2121">&quot;protocol&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>,
    <span style="color: #BA2121">&quot;step&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>,
    <span style="color: #BA2121">&quot;content_type&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;application/json&quot;</span>,
    <span style="color: #BA2121">&quot;channel_op&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;normal&quot;</span>,  <span style="color: #408080; font-style: italic">// or closed</span>
    <span style="color: #BA2121">&quot;payload&quot;</span><span style="color: #666666">:</span> <span style="color: #408080; font-style: italic">// byte array</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is all managed by Muon Core, which provides functions for creating messages and handling encoding/ decoding. To turn these into a functioning protocol, you decide what <strong>step</strong> messages you will have, and what payloads that will imply.</p>
</div>
<div class="paragraph">
<p>In our simple protocol, we will</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Send a message to a remote system with the step <code>RegisterFunction</code> that instructs the remote that it wants an answer to a question. The payload will contain a piece of text to test against and <code>X</code>, how often the answer should be sent back.</p>
</li>
<li>
<p>The remote will send messages with the step <code>answer</code> and a payload containing a <code>text</code> property.</p>
</li>
<li>
<p>Every X seconds, the remote will send back the answer.</p>
</li>
<li>
<p>After Y answers, the client will close the connection, shutting down the conversation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is kind of like RPC, but simpler and a long running aspect to it.</p>
</div>
</div>
<div class="sect3">
<h4 id="building-a-client">Building a Client</h4>
<div class="paragraph">
<p>The aim of building a Muon stack is to give a nice, user friendly API on top of distributed coordination/ messaging operation. You need to decide what this means for your API, such as whether it should be synchronous or not, the parameters and interactions that will happen.</p>
</div>
<div class="paragraph">
<p>In this case, we have an initial communication, passing the register text, along with how often you wish to be notified, and then some mechanism will be needed to pass the response back.</p>
</div>
<div class="sect4">
<h5 id="client-api">Client API</h5>
<div class="paragraph">
<p>Here is an example API, which uses a simple method call and passes a callback function for async notification of results. The function will be invoked every time you get a response back. Consider other APIs you could provide, some synchronous option, or change to a streaming API using Reactive Streams or similar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> io<span style="color: #666666">.</span><span style="color: #7D9029">muoncore</span><span style="color: #666666">.</span><span style="color: #7D9029">example</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.Muon</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.MuonBuilder</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.config.AutoConfiguration</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.config.MuonConfigBuilder</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.example.protocol.continuousfunction.ContinuousClient</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">lombok.extern.slf4j.Slf4j</span><span style="color: #666666">;</span>

<span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic"> * Simple Muon example that acts as a client</span>
<span style="color: #408080; font-style: italic"> */</span>
<span style="color: #AA22FF">@Slf4j</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ContinuousFunctionClient</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">main</span><span style="color: #666666">(</span>String<span style="color: #666666">[]</span> args<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>

        AutoConfiguration config <span style="color: #666666">=</span> MuonConfigBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withServiceIdentifier</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;example-service-client&quot;</span><span style="color: #666666">).</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>

        Muon muon <span style="color: #666666">=</span> MuonBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withConfig</span><span style="color: #666666">(</span>config<span style="color: #666666">).</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>
        muon<span style="color: #666666">.</span><span style="color: #7D9029">getDiscovery</span><span style="color: #666666">().</span><span style="color: #7D9029">blockUntilReady</span><span style="color: #666666">();</span>

        ContinuousClient client <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">ContinuousClient</span><span style="color: #666666">(</span>muon<span style="color: #666666">);</span>

        client<span style="color: #666666">.</span><span style="color: #7D9029">request</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Hello World&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">2,</span> functionResponse <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
            log<span style="color: #666666">.</span><span style="color: #7D9029">info</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Server said &quot;</span> <span style="color: #666666">+</span> functionResponse<span style="color: #666666">.</span><span style="color: #7D9029">getResponse</span><span style="color: #666666">());</span>
        <span style="color: #666666">});</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is implemented by creating a client class that takes the Muon object and uses the <code>TransportClient</code>. <code>Discovery</code>, <code>Codecs</code> and combining things together using Channels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> io<span style="color: #666666">.</span><span style="color: #7D9029">muoncore</span><span style="color: #666666">.</span><span style="color: #7D9029">example</span><span style="color: #666666">.</span><span style="color: #7D9029">protocol</span><span style="color: #666666">.</span><span style="color: #7D9029">continuousfunction</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.Muon</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.ChannelConnection</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.codec.Codecs</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.example.ContinuousFunctionClient</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonInboundMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonMessageBuilder</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonOutboundMessage</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.function.Consumer</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ContinuousClient</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> Muon muon<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">ContinuousClient</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">muon</span> <span style="color: #666666">=</span> muon<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">request</span><span style="color: #666666">(</span>String targetService<span style="color: #666666">,</span> String text<span style="color: #666666">,</span> <span style="color: #B00040">int</span> time<span style="color: #666666">,</span> Consumer<span style="color: #666666">&lt;</span>FunctionResponse<span style="color: #666666">&gt;</span> functionResponse<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        ChannelConnection<span style="color: #666666">&lt;</span>MuonOutboundMessage<span style="color: #666666">,</span> MuonInboundMessage<span style="color: #666666">&gt;</span> channel <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getTransportClient</span><span style="color: #666666">().</span><span style="color: #7D9029">openClientChannel</span><span style="color: #666666">();</span>

        channel<span style="color: #666666">.</span><span style="color: #7D9029">receive</span><span style="color: #666666">(</span>muonInboundMessage <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>   <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getStep</span><span style="color: #666666">().</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;answer&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                FunctionResponse decode <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getCodecs</span><span style="color: #666666">().</span><span style="color: #7D9029">decode</span><span style="color: #666666">(</span>muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">(),</span> muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">(),</span> FunctionResponse<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
                functionResponse<span style="color: #666666">.</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span>decode<span style="color: #666666">);</span>  <i class="conum" data-value="5"></i><b>(5)</b>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>

        Subscription sub <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">Subscription</span><span style="color: #666666">();</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        Codecs<span style="color: #666666">.</span><span style="color: #7D9029">EncodingResult</span> encode <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getCodecs</span><span style="color: #666666">().</span><span style="color: #7D9029">encode</span><span style="color: #666666">(</span>sub<span style="color: #666666">,</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getDiscovery</span><span style="color: #666666">().</span><span style="color: #7D9029">getCodecsForService</span><span style="color: #666666">(</span>targetService<span style="color: #666666">));</span>

        channel<span style="color: #666666">.</span><span style="color: #7D9029">send</span><span style="color: #666666">(</span>MuonMessageBuilder           <i class="conum" data-value="3"></i><b>(3)</b>
                <span style="color: #666666">.</span><span style="color: #7D9029">fromService</span><span style="color: #666666">(</span>muon<span style="color: #666666">.</span><span style="color: #7D9029">getConfiguration</span><span style="color: #666666">().</span><span style="color: #7D9029">getServiceName</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">protocol</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;continuous-function&quot;</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">step</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;RegisterFunction&quot;</span><span style="color: #666666">)</span>         <i class="conum" data-value="4"></i><b>(4)</b>
                <span style="color: #666666">.</span><span style="color: #7D9029">payload</span><span style="color: #666666">(</span>encode<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">contentType</span><span style="color: #666666">(</span>encode<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="building-a-server">Building a Server</h4>
<div class="paragraph">
<p>Providing a Server Stack is slightly different. You still have a managing object, that implements <code>ServerProtocolStack</code>. This object is provided to Muon Core for it to manage the lifecycle of. It provides <code>ChannnelConnections</code> on demand. Messages flow up and down the <code>ChannelConnection</code>, with each connection being a conversation with some remote service. Generally, conversation state is associated with the `ChannelConnection</p>
</div>
<div class="paragraph">
<p>The basic API of a <code>ServerProtocolStack</code> is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">ProtocolDescriptor <span style="color: #0000FF">getProtocolDescriptor</span><span style="color: #666666">();</span>                   <i class="conum" data-value="1"></i><b>(1)</b>
Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> SchemaDescriptor<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getSchemasFor</span><span style="color: #666666">(</span>String endpoint<span style="color: #666666">);</span>     <i class="conum" data-value="2"></i><b>(2)</b>
ChannelConnection<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> <span style="color: #0000FF">createChannel</span><span style="color: #666666">();</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Provide information about the stack for <code>introspection</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Optionally, provide schema/ type information, given a nominal endpoint, names of which will have been supplied in (1)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Main function. Invoked by Muon Core whenever a new connection is opened for the protocol this stack provides.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implementing this API is mostly about creating ChannelConnections and putting the Protocol behind them to trade messages with the client. You may notice that the <code>ChannelConnection</code> is the other way around in its generic information (MuonInbound vs Outbound), but that they otherwise match. The two channels are logically c</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> io<span style="color: #666666">.</span><span style="color: #7D9029">muoncore</span><span style="color: #666666">.</span><span style="color: #7D9029">example</span><span style="color: #666666">.</span><span style="color: #7D9029">protocol</span><span style="color: #666666">.</span><span style="color: #7D9029">continuousfunction</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.Muon</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.Channel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.ChannelConnection</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.Channels</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.support.Scheduler</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.codec.Codecs</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.descriptors.ProtocolDescriptor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.descriptors.SchemaDescriptor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonInboundMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonMessageBuilder</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonOutboundMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.protocol.ServerProtocolStack</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Map</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.concurrent.TimeUnit</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.function.Consumer</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ContinuousServer</span> <span style="color: #008000; font-weight: bold">implements</span> ServerProtocolStack <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> Muon muon<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> Scheduler<span style="color: #666666">.</span><span style="color: #7D9029">TimerControl</span> timerControl<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">ContinuousServer</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">muon</span> <span style="color: #666666">=</span> muon<span style="color: #666666">;</span>
        muon<span style="color: #666666">.</span><span style="color: #7D9029">getProtocolStacks</span><span style="color: #666666">().</span><span style="color: #7D9029">registerServerProtocol</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> SchemaDescriptor<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getSchemasFor</span><span style="color: #666666">(</span>String s<span style="color: #666666">)</span> <span style="color: #666666">{</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> ProtocolDescriptor <span style="color: #0000FF">getProtocolDescriptor</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>          <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> ChannelConnection<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> <span style="color: #0000FF">createChannel</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        Channel<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> channel <span style="color: #666666">=</span> Channels<span style="color: #666666">.</span><span style="color: #7D9029">channel</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;transport&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;api&quot;</span><span style="color: #666666">);</span>

        channel<span style="color: #666666">.</span><span style="color: #7D9029">right</span><span style="color: #666666">().</span><span style="color: #7D9029">receive</span><span style="color: #666666">(</span>muonInboundMessage <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>

            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>muonInboundMessage <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getChannelOperation</span><span style="color: #666666">()</span> <span style="color: #666666">==</span> MuonMessage<span style="color: #666666">.</span><span style="color: #7D9029">ChannelOperation</span><span style="color: #666666">.</span><span style="color: #7D9029">closed</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>timerControl <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    timerControl<span style="color: #666666">.</span><span style="color: #7D9029">cancel</span><span style="color: #666666">();</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>

            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getStep</span><span style="color: #666666">().</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;RegisterFunction&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                Subscription decode <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getCodecs</span><span style="color: #666666">().</span><span style="color: #7D9029">decode</span><span style="color: #666666">(</span>
                        muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">(),</span>
                        muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">(),</span> Subscription<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

                sendResponse<span style="color: #666666">(</span>channel<span style="color: #666666">,</span> muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getSourceServiceName</span><span style="color: #666666">());</span>

                timerControl <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getScheduler</span><span style="color: #666666">().</span><span style="color: #7D9029">executeIn</span><span style="color: #666666">(1000,</span> TimeUnit<span style="color: #666666">.</span><span style="color: #7D9029">MILLISECONDS</span><span style="color: #666666">,</span> <span style="color: #666666">()</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
                    sendResponse<span style="color: #666666">(</span>channel<span style="color: #666666">,</span> muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getSourceServiceName</span><span style="color: #666666">());</span>
                <span style="color: #666666">});</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>

        <span style="color: #008000; font-weight: bold">return</span> channel<span style="color: #666666">.</span><span style="color: #7D9029">left</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">sendResponse</span><span style="color: #666666">(</span>Channel<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> channel<span style="color: #666666">,</span> String sourceService<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        FunctionResponse response <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">FunctionResponse</span><span style="color: #666666">();</span>
        Codecs<span style="color: #666666">.</span><span style="color: #7D9029">EncodingResult</span> encode <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getCodecs</span><span style="color: #666666">().</span><span style="color: #7D9029">encode</span><span style="color: #666666">(</span>response<span style="color: #666666">,</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getDiscovery</span><span style="color: #666666">().</span><span style="color: #7D9029">getCodecsForService</span><span style="color: #666666">(</span>sourceService<span style="color: #666666">));</span>

        channel<span style="color: #666666">.</span><span style="color: #7D9029">right</span><span style="color: #666666">().</span><span style="color: #7D9029">send</span><span style="color: #666666">(</span>MuonMessageBuilder<span style="color: #666666">.</span><span style="color: #7D9029">fromService</span><span style="color: #666666">(</span>muon<span style="color: #666666">.</span><span style="color: #7D9029">getConfiguration</span><span style="color: #666666">().</span><span style="color: #7D9029">getServiceName</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">protocol</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;continuous-function&quot;</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">toService</span><span style="color: #666666">(</span>sourceService<span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">step</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;answer&quot;</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">payload</span><span style="color: #666666">(</span>encode<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">contentType</span><span style="color: #666666">(</span>encode<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">()</span>
        <span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Return a list of the available schemas used by the server, both inbound and outbound. Accessible via the introspection protocol.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the full protocol descriptor, used by introspection.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Open a channel to this protocol. This is the core API. You must provide an implementation of the channel interface that is fully connected to any server protocol, managing apis and server side state.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="building-the-protocol-machines">Building the Protocol Machines</h4>
<div class="paragraph">
<p>The API is the part of the system that makes messaging easy to use. As such, you should make it intuitive and represent the ideas you are talking about simply and to the point.   Underneath the API is a messaging system that uses the facilities of Muon Core to find and talk to remote systems in a structured way using messaging.</p>
</div>
<div class="paragraph">
<p>This is known in Muon as a "protocol". It is fairly free form in how it <em>can</em> work, there is no interfaces or apis that must be implemented to make it work. In all cases you need some code to translate interactions with the stack API into Muon messages that are sent down a channel to some remote system and on the way back again convert the inbound messages into something useful.</p>
</div>
<div class="paragraph">
<p>There are best practice patterns for implementing these protocols, however. If you want your protocol to be fully portable, implement it as a <code>JSProtocol</code>. This allows your core messaging interactions to be written once and then integrated into the various implementations of Muon Core, only needing to implement the API in each runtime you want to support.</p>
</div>
<div class="sect4">
<h5 id="java-embedded-protocol">Java embedded protocol</h5>
<div class="paragraph">
<p>To make a new server side stack, you implement the <code>ServerStack</code> interface and then register it in the server stacks registry. Generally, this is done within a managing object that registers itself.</p>
</div>
<div class="paragraph">
<p>This implementation of <code>ServerStacks</code> is</p>
</div>
<div class="paragraph">
<p>Here is the continuous function client protocol implemented in Java</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> io<span style="color: #666666">.</span><span style="color: #7D9029">muoncore</span><span style="color: #666666">.</span><span style="color: #7D9029">example</span><span style="color: #666666">.</span><span style="color: #7D9029">protocol</span><span style="color: #666666">.</span><span style="color: #7D9029">continuousfunction</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.Muon</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.Channel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.ChannelConnection</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.Channels</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.support.Scheduler</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.codec.Codecs</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.descriptors.ProtocolDescriptor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.descriptors.SchemaDescriptor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonInboundMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonMessageBuilder</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonOutboundMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.protocol.ServerProtocolStack</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Map</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.concurrent.TimeUnit</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.function.Consumer</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ContinuousServer</span> <span style="color: #008000; font-weight: bold">implements</span> ServerProtocolStack <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> Muon muon<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> Scheduler<span style="color: #666666">.</span><span style="color: #7D9029">TimerControl</span> timerControl<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">ContinuousServer</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">muon</span> <span style="color: #666666">=</span> muon<span style="color: #666666">;</span>
        muon<span style="color: #666666">.</span><span style="color: #7D9029">getProtocolStacks</span><span style="color: #666666">().</span><span style="color: #7D9029">registerServerProtocol</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> SchemaDescriptor<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getSchemasFor</span><span style="color: #666666">(</span>String s<span style="color: #666666">)</span> <span style="color: #666666">{</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> ProtocolDescriptor <span style="color: #0000FF">getProtocolDescriptor</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>          <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> ChannelConnection<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> <span style="color: #0000FF">createChannel</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        Channel<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> channel <span style="color: #666666">=</span> Channels<span style="color: #666666">.</span><span style="color: #7D9029">channel</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;transport&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;api&quot;</span><span style="color: #666666">);</span>

        channel<span style="color: #666666">.</span><span style="color: #7D9029">right</span><span style="color: #666666">().</span><span style="color: #7D9029">receive</span><span style="color: #666666">(</span>muonInboundMessage <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>

            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>muonInboundMessage <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getChannelOperation</span><span style="color: #666666">()</span> <span style="color: #666666">==</span> MuonMessage<span style="color: #666666">.</span><span style="color: #7D9029">ChannelOperation</span><span style="color: #666666">.</span><span style="color: #7D9029">closed</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>timerControl <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    timerControl<span style="color: #666666">.</span><span style="color: #7D9029">cancel</span><span style="color: #666666">();</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>

            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getStep</span><span style="color: #666666">().</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;RegisterFunction&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                Subscription decode <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getCodecs</span><span style="color: #666666">().</span><span style="color: #7D9029">decode</span><span style="color: #666666">(</span>
                        muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">(),</span>
                        muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">(),</span> Subscription<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

                sendResponse<span style="color: #666666">(</span>channel<span style="color: #666666">,</span> muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getSourceServiceName</span><span style="color: #666666">());</span>

                timerControl <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getScheduler</span><span style="color: #666666">().</span><span style="color: #7D9029">executeIn</span><span style="color: #666666">(1000,</span> TimeUnit<span style="color: #666666">.</span><span style="color: #7D9029">MILLISECONDS</span><span style="color: #666666">,</span> <span style="color: #666666">()</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
                    sendResponse<span style="color: #666666">(</span>channel<span style="color: #666666">,</span> muonInboundMessage<span style="color: #666666">.</span><span style="color: #7D9029">getSourceServiceName</span><span style="color: #666666">());</span>
                <span style="color: #666666">});</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>

        <span style="color: #008000; font-weight: bold">return</span> channel<span style="color: #666666">.</span><span style="color: #7D9029">left</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">sendResponse</span><span style="color: #666666">(</span>Channel<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> channel<span style="color: #666666">,</span> String sourceService<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        FunctionResponse response <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">FunctionResponse</span><span style="color: #666666">();</span>
        Codecs<span style="color: #666666">.</span><span style="color: #7D9029">EncodingResult</span> encode <span style="color: #666666">=</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getCodecs</span><span style="color: #666666">().</span><span style="color: #7D9029">encode</span><span style="color: #666666">(</span>response<span style="color: #666666">,</span> muon<span style="color: #666666">.</span><span style="color: #7D9029">getDiscovery</span><span style="color: #666666">().</span><span style="color: #7D9029">getCodecsForService</span><span style="color: #666666">(</span>sourceService<span style="color: #666666">));</span>

        channel<span style="color: #666666">.</span><span style="color: #7D9029">right</span><span style="color: #666666">().</span><span style="color: #7D9029">send</span><span style="color: #666666">(</span>MuonMessageBuilder<span style="color: #666666">.</span><span style="color: #7D9029">fromService</span><span style="color: #666666">(</span>muon<span style="color: #666666">.</span><span style="color: #7D9029">getConfiguration</span><span style="color: #666666">().</span><span style="color: #7D9029">getServiceName</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">protocol</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;continuous-function&quot;</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">toService</span><span style="color: #666666">(</span>sourceService<span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">step</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;answer&quot;</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">payload</span><span style="color: #666666">(</span>encode<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">contentType</span><span style="color: #666666">(</span>encode<span style="color: #666666">.</span><span style="color: #7D9029">getContentType</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">()</span>
        <span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jsprotocol-version">JSProtocol version</h5>
<div class="paragraph">
<p>One potential problem with the above is having to change the implementation of the protocol and manage that change across different languages and runtimes. It is possible to implement the protocol section in a javascript module and access that</p>
</div>
<div class="paragraph">
<p>Here is the same protocol implemented using JSProtocol and integrated into the stack</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> io<span style="color: #666666">.</span><span style="color: #7D9029">muoncore</span><span style="color: #666666">.</span><span style="color: #7D9029">example</span><span style="color: #666666">.</span><span style="color: #7D9029">protocol</span><span style="color: #666666">.</span><span style="color: #7D9029">continuousfunction</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.Muon</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.Channel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.ChannelConnection</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.channel.Channels</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.descriptors.ProtocolDescriptor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.descriptors.SchemaDescriptor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonInboundMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.message.MuonOutboundMessage</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.protocol.JSProtocol</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.protocol.ServerJSProtocol</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">io.muoncore.protocol.ServerProtocolStack</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Map</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.function.Supplier</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ContinuousJSServer</span> <span style="color: #008000; font-weight: bold">implements</span> ServerProtocolStack <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> Muon muon<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">ContinuousJSServer</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">muon</span> <span style="color: #666666">=</span> muon<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> SchemaDescriptor<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getSchemasFor</span><span style="color: #666666">(</span>String s<span style="color: #666666">)</span> <span style="color: #666666">{</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> ProtocolDescriptor <span style="color: #0000FF">getProtocolDescriptor</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>          <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> ChannelConnection<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> <span style="color: #0000FF">createChannel</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        Channel<span style="color: #666666">&lt;</span>MuonInboundMessage<span style="color: #666666">,</span> MuonOutboundMessage<span style="color: #666666">&gt;</span> channel <span style="color: #666666">=</span> Channels<span style="color: #666666">.</span><span style="color: #7D9029">channel</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;transport&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;api&quot;</span><span style="color: #666666">);</span>

        ServerJSProtocol serverJSProtocol <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">ServerJSProtocol</span><span style="color: #666666">(</span>muon<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;server-protocol&quot;</span><span style="color: #666666">,</span> channel<span style="color: #666666">.</span><span style="color: #7D9029">right</span><span style="color: #666666">());</span><i class="conum" data-value="4"></i><b>(4)</b>
        serverJSProtocol<span style="color: #666666">.</span><span style="color: #7D9029">addTypeForDecoding</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Subscription&quot;</span><span style="color: #666666">,</span> Subscription<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        serverJSProtocol<span style="color: #666666">.</span><span style="color: #7D9029">start</span><span style="color: #666666">(</span>ContinuousJSServer<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">.</span><span style="color: #7D9029">getResourceAsStream</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;/continuous-server.js&quot;</span><span style="color: #666666">));</span>

        serverJSProtocol<span style="color: #666666">.</span><span style="color: #7D9029">setState</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;generator&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">(</span>Supplier<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;)</span> <span style="color: #666666">()</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;GENERATED TEXT &quot;</span> <span style="color: #666666">+</span> System<span style="color: #666666">.</span><span style="color: #7D9029">currentTimeMillis</span><span style="color: #666666">();</span>
        <span style="color: #666666">});</span>

        <span style="color: #008000; font-weight: bold">return</span> channel<span style="color: #666666">.</span><span style="color: #7D9029">left</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSProtocol implementation looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">module<span style="color: #666666">.</span><span style="color: #7D9029">exports</span> <span style="color: #666666">=</span> function<span style="color: #666666">(</span>api<span style="color: #666666">)</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">{</span>
        <span style="color: #A0A000">fromTransport:</span> function <span style="color: #666666">(</span>msg<span style="color: #666666">)</span> <span style="color: #666666">{</span>


            var request <span style="color: #666666">=</span> api<span style="color: #666666">.</span><span style="color: #7D9029">decode</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Subscription&quot;</span><span style="color: #666666">,</span> msg<span style="color: #666666">)</span>

            var handler <span style="color: #666666">=</span> api<span style="color: #666666">.</span><span style="color: #7D9029">state</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;getHandler&quot;</span><span style="color: #666666">)(</span>request<span style="color: #666666">);</span>

            handler<span style="color: #666666">(</span>function<span style="color: #666666">(</span>response<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                var ret <span style="color: #666666">=</span> api<span style="color: #666666">.</span><span style="color: #7D9029">encodeFor</span><span style="color: #666666">(</span>response<span style="color: #666666">.</span><span style="color: #7D9029">payload</span><span style="color: #666666">,</span> msg<span style="color: #666666">.</span><span style="color: #7D9029">sourceServiceName</span><span style="color: #666666">)</span>
                api<span style="color: #666666">.</span><span style="color: #7D9029">sendTransport</span><span style="color: #666666">({</span>
                    <span style="color: #A0A000">step:</span> <span style="color: #BA2121">&quot;request.response&quot;</span><span style="color: #666666">,</span>
                    <span style="color: #A0A000">payload:</span> <span style="color: #666666">{</span>
                        <span style="color: #A0A000">status:</span> response<span style="color: #666666">.</span><span style="color: #7D9029">status</span><span style="color: #666666">,</span>
                        <span style="color: #A0A000">content_type:</span> ret<span style="color: #666666">.</span><span style="color: #7D9029">contentType</span><span style="color: #666666">,</span>
                        <span style="color: #A0A000">body:</span> ret<span style="color: #666666">.</span><span style="color: #7D9029">payload</span>
                    <span style="color: #666666">}</span>
                <span style="color: #666666">})</span>
                api<span style="color: #666666">.</span><span style="color: #7D9029">shutdown</span><span style="color: #666666">()</span>
            <span style="color: #666666">});</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">};</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is equivalent to the above Java implementation, with the advantage that it can also be used within another Muon runtime environment to give compatible behaviour</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing-the-stacks">Testing the Stacks</h3>
<div class="paragraph">
<p>There are few different ways to test your shiny new stacks, depending how much infrastructure you want to include in the test.</p>
</div>
<div class="paragraph">
<p>Taking Muon Java as the basis, you can</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unit test the stacks as normal, mock the transport client/ server api as appropriate, with most expectations set as "message X received", "message Y sent"</p>
</li>
<li>
<p>Instantiate the client/ server and attch their channels together using <code>Channels.connectAndTransform</code>. This tests the stacks against each other as an integration test, with none of the machinery of a transport/ discovery/ compression etc.</p>
</li>
<li>
<p>Instantiate two muon instances, use the in memory transport and attach the client/ server. A full integration test</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally, it is preferred to implement a test of each kind to ensure compatibility with the different messages that can be created at each level.</p>
</div>
<div class="paragraph">
<p>The Muon transport layer will emit <code>ChannelFailed</code> and <code>ServiceNotFound</code> messages in some circumstances and your protocol <strong>must</strong> receive and correctly handle these to clean up/ inform the app code via the API, if appropriate.</p>
</div>
</div>
</div>
</div>
        </div>
      </div>

      <div class='four spacing'></div>
    </div>
  </div>
</div>
</div>

    </div>

    

  <!--End mc_embed_signup-->
<div class='full no-padding' style='background: #111'>
  <div class='two spacing'></div>
  <div class='row'>
    <div class='large-12 columns' style="color:white;">
      <p>©2017 Muon Core Ltd. All rights reserved.</p>
    </div>
  </div>
  <div class='spacing'></div>
</div>


<script src="/javascripts/jquery.countTo.js" type="text/javascript"></script>
<script src="/javascripts/jquery.appear.js" type="text/javascript"></script>
<script src="/javascripts/jquery.validate.js" type="text/javascript"></script>
<script src="/javascripts/jquery.sequence-min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75338923-1', 'auto');
  ga('require', 'linkid');
  ga('send', 'pageview');

</script>


  </body>

</html>
