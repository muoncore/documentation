<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Building an API</title>
  <meta name="description" content="">

    <link rel="stylesheet" href="/css/foundation.css">

    <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <script src="/javascripts/modernizr.foundation.js" type="text/javascript"></script>
    <script src="/javascripts/jquery-2.1.0.js" type="text/javascript"></script>
    <script src="/javascripts/terrific-1.1.1.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.url.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="/javascripts/json2.js" type="text/javascript"></script>
    <script src="/javascripts/foundation.js" type="text/javascript"></script>
  <script>
    // terrificjs bootstrap
    (function($) {
        $(document).ready(function() {
            var $page = $('body');
            var config = {
              dependencyPath: {
                plugin: 'javascripts/'
              }
            }
            var application = new Tc.Application($page, config);
            application.registerModules();
            application.start();
        });
    })(Tc.$);
  </script>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,700,300" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/masonry.pkgd.js" type="text/javascript"></script>
  <script src="/javascripts/imagesloaded.pkgd.min.js" type="text/javascript"></script>
  <script src="/javascripts/slick.min.js" type="text/javascript"></script>

  <link rel="canonical" href="/guide/3-events/">
  <link rel="alternate" type="application/rss+xml" title="Muon - Reactive APIs" href="/feed.xml" />
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
          <link rel="stylesheet" href="/css/asciidoc.css">
          <link rel="stylesheet" href="/css/producttable.css">
                  <style>
  @media only screen and (min-width:768px){#toctitle{font-size:1.375em}
      body.toc2{padding-left:15em;padding-right:0}
#toc {margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;right:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc >ul{font-size:.9em;margin-bottom:0}
#toc ul ul{margin-left:0;padding-left:1em}
#toc ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
  @media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc {width:20em}
#toc #toctitle{font-size:1.375em}
#toc >ul{font-size:.95em}
#toc ul ul{padding-left:1.25em}
      body.toc2.toc-right{padding-left:0;padding-right:20em}}

#toc { z-index:20; padding-top:120px;}
#documentation { padding-left:10px; margin-left:auto; margin-right:auto}
#documentation .row { margin:auto }
      code {
          background:none;
          border:0;
      }

      code span { border: 0; width:100% }
      .listingblock {
         background: #eee;
         border-radius:5px;
          border:1px solid #ccc
      }
  }

  div.documentation a.btn {
    margin-top:20px;
    background: #3498db;
    background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
    background-image: -moz-linear-gradient(top, #3498db, #2980b9);
    background-image: -ms-linear-gradient(top, #3498db, #2980b9);
    background-image: -o-linear-gradient(top, #3498db, #2980b9);
    background-image: linear-gradient(to bottom, #3498db, #2980b9);
    -webkit-border-radius: 28;
    -moz-border-radius: 28;
    border-radius: 28px;
    font-family: Arial;
    color: #ffffff;
    font-size: 20px;
    padding: 10px 20px 10px 20px;
    text-decoration: none;
  }

  div.documentation a.btn:hover {
    background: #3cb0fd;
    background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
    background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
    text-decoration: none;
  }

  </style>

  <link rel="stylesheet" href="/css/sidebar2.css">
</head>


  <body>
    
      <a id='top'></a>
<div class='contain-to-grid sticky fullwidth'>
  <nav class='top-bar onepage' data-options='sticky_on: large' data-topbar=''>
    <ul class='title-area'>
      <li class='name'>
        <h1>
          <a href="/">
            <img alt="" src="/images/muonlogo.png" style="width:50px; height:50px" /> Muon
          </a>
        </h1>
      </li>
      <li class='toggle-topbar menu-icon'>
        <a href='#'>Menu</a>
      </li>
    </ul>
    <span style="float:left">Reactive APIs for Microservices, Browser and More ...</span>
    <section class='top-bar-section'>
      <ul class='right'>
        
          
            <li>
              
                <a href="guide/index.html">Guides</a>
              

            </li>
          
        
          
            <li class="has-dropdown">
              <a href="/guide/index.html">Docs</a>
              <ul class='dropdown'>
                
                  <li>
                    <a href="/guide/index.html">Guides</a>
                  </li>
                
                  <li>
                    <a href="/submodules/cli/doc/index.html">CLI</a>
                  </li>
                
                  <li>
                    <a href="/submodules/java/doc/">Java</a>
                  </li>
                
                  <li>
                    <a href="/submodules/clojure/doc/index.html">Clojure</a>
                  </li>
                
                  <li>
                    <a href="/submodules/node/doc/index.html">Node.JS</a>
                  </li>
                
                  <li>
                    <a href="/submodules/muonjs/doc/index.html">Browser</a>
                  </li>
                
                  <li>
                    <a href="/submodules/photon/doc/index.html">Photon - Event Store</a>
                  </li>
                
              </ul>
            </li>
          
        
          
            <li>
              
                <a href="https://github.com/muoncore">Github</a>
              

            </li>
          
        
      </ul>
    </section>
  </nav>
</div>
<div class='full no-padding'>
  <!-- Begin MailChimp Signup Form -->
  <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
         We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
  </style>
  <div id="mc_embed_signup">
    <form action="//simplicityitself.us9.list-manage.com/subscribe/post?u=fce1e12e8f44592cf75288e11&amp;id=98e2ce96d8" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Get updated on new releases and features</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_fce1e12e8f44592cf75288e11_98e2ce96d8" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
      </div>
    </form>
  </div>
</div>

    

    <div id='main' role='main'>
      <div class="documentation">
<div class='full' style='background: #000'>
  <div class='row' style="margin-left:0; margin-right:0; max-width:100%">
    <div class='large-12 columns'>
      <div class='mod modBlogPost big'>
        <div class='images'>
          
        </div>
        <div class='content' style="font-size:1.2rem; max-width:80%">
          <h1>Guide: Building an API</h1>
<div id="toc" class="toc">
<div id="toctitle">Getting Started</div>
<ul class="sectlevel1">
<li><a href="#get-started-with-events">Get Started with Events</a></li>
<li><a href="#the-menu">The Menu</a>
<ul class="sectlevel2">
<li><a href="#adding-to-the-menu">Adding to the Menu</a></li>
<li><a href="#building-the-menu-state-from-the-stream">Building the Menu state from the Stream</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This guide is maintained at <a href="https://github.com/muoncore/guide" class="bare">https://github.com/muoncore/guide</a> Please submit issues at that repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this guide you will</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Learn about events, using Photon</p>
</li>
<li>
<p>Persist updates to the Menu using Event Sourcing</p>
</li>
<li>
<p>Persist Orders as Events and make the Orders Microservice use a stream processed view.</p>
</li>
<li>
<p>See application level Eventual Consistency in both services</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unresolved directive in index.adoc - include::guide/3-events/../12daypromo.adoc[]</p>
</div>
<div class="sect1">
<h2 id="get-started-with-events">Get Started with Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may have come across the term <em>event</em> in terms of application integration and communication.</p>
</div>
<div class="paragraph">
<p>At its simplest, an event is a broadcast describing something that has happened in a system.
THis style of integration is often used in User Interfaces, as they tend to be highly complex systems
with particular threading pressure.</p>
</div>
<div class="paragraph">
<p>Building a distributed Microservice style system has many of the same pressures. We can use the concept of events
to build the a distributed system.</p>
</div>
<div class="paragraph">
<p>On top of regular event semantics, we will be using a concept known as <em>event sourcing</em>. This is an approach invented by Greg Young,
used in the concext of Domain Driven Design.</p>
</div>
<div class="paragraph">
<p>Event sourcing says that you can build the state of a component by replaying all the things that have happened that affect it.</p>
</div>
<div class="paragraph">
<p>These things, events, need to be persisted externally from the component in question, and then used to build its state.</p>
</div>
<div class="paragraph">
<p>In the Muon world, following our philosophy of adding systemic value through protocols and services, we have a service <strong>Photon</strong>, that performs
event persistence, in the form of streams. We additionally have <strong>Event Protocols</strong>, permitting event emit and arbitrary replay, that
Photon provides the server side implementation of.</p>
</div>
<div class="paragraph">
<p>Your code can use the event clients, and gain access to events, using Photon or any event store implementing the same protocols.</p>
</div>
<div id="streams" class="imageblock">
<div class="content">
<img src="../images/3-streams.png" alt="Streams">
</div>
<div class="title">Figure 1. Streams in Photon</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-menu">The Menu</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Menu we want to display is a simple data structure, like this JSON representation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">[
  {
     <span style="color: #BA2121">&quot;name&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;Apple Pie&quot;</span>,
     <span style="color: #BA2121">&quot;id&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;apple-pie&quot;</span>,
     <span style="color: #BA2121">&quot;description&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;A pie, with apples&quot;</span>,
     <span style="color: #BA2121">&quot;price&quot;</span><span style="color: #666666">:</span> <span style="color: #BA2121">&quot;5.99&quot;</span>
  },
  <span style="color: #408080; font-style: italic">// .... more items</span>
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The question we ask is where does this data come from, and how to we change it?</p>
</div>
<div class="paragraph">
<p>To make an event sourced approach work, you have to understand how to build this structure
based upon the incremental changes to it via the events.</p>
</div>
<div class="paragraph">
<p>These are applied in order via a functional approach (ideally a true function).</p>
</div>
<div class="sect2">
<h3 id="adding-to-the-menu">Adding to the Menu</h3>
<div class="paragraph">
<p>To start with, we need to understand the events that will be used to build this Menu domain.
This process is known by many names (eg, <a href="http://ziobrando.blogspot.de/2013/11/introducing-event-storming.html">Event Storming</a>),
and involves modelling your domains and seeing what happenings are going on. These are you events.</p>
</div>
<div class="paragraph">
<p>In the case of the Menu, we will start with two things we want to happen, adding a product and updating the price.</p>
</div>
<div class="paragraph">
<p>These will be known as <em>ProductAdded</em> and <em>PriceUpdated</em></p>
</div>
<div class="paragraph">
<p>Muon supports events in all implementations, including the CLI.</p>
</div>
<div class="paragraph">
<p>You can emit the above events from the CLI like so</p>
</div>
<div class="listingblock">
<div class="title">Product Added Event via the Muon CLI</div>
<div class="content">
<pre>&gt; muon event '{ "event-type": "ProductAdded", \  <i class="conum" data-value="1"></i><b>(1)</b>
      "stream-name": "menu",                  \  <i class="conum" data-value="2"></i><b>(2)</b>
      "payload": {                            \  <i class="conum" data-value="3"></i><b>(3)</b>
                "name": "Apple Pie",          \
                     "id": "apple-pie",       \
                     "description": "A pie, with apples",\
                     "price": "5.99"  \
             }}'</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The type of the event</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The logical stream to persist to. This is used to trigger a replay.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The payload, the data we need to update the Menu aggregate</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Price Updated Event via the Muon CLI</div>
<div class="content">
<pre>&gt; muon event '{ "event-type": "PriceUpdated", \
      "stream-name": "something",             \
      "payload": {                            \  <i class="conum" data-value="1"></i><b>(1)</b>
               "id": "apple-pie",             \
               "price": "5.99"                \
       }}'</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note we only need to pass the delta of the data we are updating.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Between them, these two events give us the enough information to build the data structure above.</p>
</div>
<div class="paragraph">
<p>Next, we will use this raw state to build the menu data structure.</p>
</div>
</div>
<div class="sect2">
<h3 id="building-the-menu-state-from-the-stream">Building the Menu state from the Stream</h3>
<div class="paragraph">
<p>You have many options for where you are going to store the Menu data. For this data,
we can just store it in memory, as it will be very small.</p>
</div>
<div class="paragraph">
<p>The event source approach will give us all the durability guarantees we need and handle our
consistency in the way we want. The data is small enough to query programmatically.</p>
</div>
<div class="paragraph">
<p>If you have a larger data set, you can still take advantage of event sourcing in the same way
as shown here, but you will likely need a more optimised query engine to work with.</p>
</div>
<div class="paragraph">
<p>Our goal now it to take the service from the previous guide and update it to build its state from
the above two events.</p>
</div>
<div class="paragraph">
<p>Taking the Menu service from the previous tutorial, we need to update it</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You now have two services interacting with each other in a Reactive way.</p>
</div>
<div class="paragraph">
<p>You have event sourced them, using Photon as the event store.</p>
</div>
<div class="paragraph">
<p>In the next episode of the series, you will investigate various techniques to test these
services, individually and sustemically.</p>
</div>
</div>
</div>

        </div>
      </div>

      <div class='four spacing'></div>
    </div>
  </div>
</div>
</div>

    </div>

    

  <!--End mc_embed_signup-->
<div class='full no-padding' style='background: #111'>
  <div class='two spacing'></div>
  <div class='row'>
    <div class='large-12 columns' style="color:white;">
      <p>©2017 Muon Core Ltd. All rights reserved.</p>
    </div>
  </div>
  <div class='spacing'></div>
</div>


<script src="/javascripts/jquery.countTo.js" type="text/javascript"></script>
<script src="/javascripts/jquery.appear.js" type="text/javascript"></script>
<script src="/javascripts/jquery.validate.js" type="text/javascript"></script>
<script src="/javascripts/jquery.sequence-min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75338923-1', 'auto');
  ga('require', 'linkid');
  ga('send', 'pageview');

</script>


  </body>

</html>
