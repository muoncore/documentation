<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Building an API</title>
  <meta name="description" content="">

    <link rel="stylesheet" href="/css/foundation.css">

    <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <script src="/javascripts/modernizr.foundation.js" type="text/javascript"></script>
    <script src="/javascripts/jquery-2.1.0.js" type="text/javascript"></script>
    <script src="/javascripts/terrific-1.1.1.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.url.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="/javascripts/json2.js" type="text/javascript"></script>
    <script src="/javascripts/foundation.js" type="text/javascript"></script>
  <script>
    // terrificjs bootstrap
    (function($) {
        $(document).ready(function() {
            var $page = $('body');
            var config = {
              dependencyPath: {
                plugin: 'javascripts/'
              }
            }
            var application = new Tc.Application($page, config);
            application.registerModules();
            application.start();
        });
    })(Tc.$);
  </script>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,700,300" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/masonry.pkgd.js" type="text/javascript"></script>
  <script src="/javascripts/imagesloaded.pkgd.min.js" type="text/javascript"></script>
  <script src="/javascripts/slick.min.js" type="text/javascript"></script>

  <link rel="canonical" href="/guide/2-api/">
  <link rel="alternate" type="application/rss+xml" title="Muon - Reactive APIs" href="/feed.xml" />
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
          <link rel="stylesheet" href="/css/asciidoc.css">
          <link rel="stylesheet" href="/css/producttable.css">
                  <style>
  @media only screen and (min-width:768px){#toctitle{font-size:1.375em}
      body.toc2{padding-left:15em;padding-right:0}
#toc {margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;right:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc >ul{font-size:.9em;margin-bottom:0}
#toc ul ul{margin-left:0;padding-left:1em}
#toc ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
  @media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc {width:20em}
#toc #toctitle{font-size:1.375em}
#toc >ul{font-size:.95em}
#toc ul ul{padding-left:1.25em}
      body.toc2.toc-right{padding-left:0;padding-right:20em}}

#toc { z-index:20; padding-top:120px;}
#documentation { padding-left:10px; margin-left:auto; margin-right:auto}
#documentation .row { margin:auto }
      code {
          background:none;
          border:0;
      }

      code span { border: 0; width:100% }
      .listingblock {
         background: #eee;
         border-radius:5px;
          border:1px solid #ccc
      }
  }

  div.documentation a.btn {
    margin-top:20px;
    background: #3498db;
    background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
    background-image: -moz-linear-gradient(top, #3498db, #2980b9);
    background-image: -ms-linear-gradient(top, #3498db, #2980b9);
    background-image: -o-linear-gradient(top, #3498db, #2980b9);
    background-image: linear-gradient(to bottom, #3498db, #2980b9);
    -webkit-border-radius: 28;
    -moz-border-radius: 28;
    border-radius: 28px;
    font-family: Arial;
    color: #ffffff;
    font-size: 20px;
    padding: 10px 20px 10px 20px;
    text-decoration: none;
  }

  div.documentation a.btn:hover {
    background: #3cb0fd;
    background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
    background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
    text-decoration: none;
  }

  </style>

  <link rel="stylesheet" href="/css/sidebar2.css">
</head>


  <body>
    
      <a id='top'></a>
<div class='contain-to-grid sticky fullwidth'>
  <nav class='top-bar onepage' data-options='sticky_on: large' data-topbar=''>
    <ul class='title-area'>
      <li class='name'>
        <h1>
          <a href="/">
            <img alt="" src="/images/muonlogo.png" style="width:50px; height:50px" /> Muon
          </a>
        </h1>
      </li>
      <li class='toggle-topbar menu-icon'>
        <a href='#'>Menu</a>
      </li>
    </ul>
    <span style="float:left">Reactive APIs for Microservices, Browser and More ...</span>
    <section class='top-bar-section'>
      <ul class='right'>
        
          
            <li>
              
                <a href="guide/index.html">Guides</a>
              

            </li>
          
        
          
            <li class="has-dropdown">
              <a href="/guide/index.html">Docs</a>
              <ul class='dropdown'>
                
                  <li>
                    <a href="/guide/index.html">Guides</a>
                  </li>
                
                  <li>
                    <a href="/submodules/cli/doc/index.html">CLI</a>
                  </li>
                
                  <li>
                    <a href="/submodules/java/doc/">Java</a>
                  </li>
                
                  <li>
                    <a href="/submodules/clojure/doc/index.html">Clojure</a>
                  </li>
                
                  <li>
                    <a href="/submodules/node/doc/index.html">Node.JS</a>
                  </li>
                
                  <li>
                    <a href="/submodules/muonjs/doc/index.html">Browser</a>
                  </li>
                
                  <li>
                    <a href="/submodules/photon/doc/index.html">Photon - Event Store</a>
                  </li>
                
              </ul>
            </li>
          
        
          
            <li>
              
                <a href="https://github.com/muoncore">Github</a>
              

            </li>
          
        
      </ul>
    </section>
  </nav>
</div>
<div class='full no-padding'>
  <!-- Begin MailChimp Signup Form -->
  <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
         We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
  </style>
  <div id="mc_embed_signup">
    <form action="//simplicityitself.us9.list-manage.com/subscribe/post?u=fce1e12e8f44592cf75288e11&amp;id=98e2ce96d8" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Get updated on new releases and features</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_fce1e12e8f44592cf75288e11_98e2ce96d8" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
      </div>
    </form>
  </div>
</div>

    

    <div id='main' role='main'>
      <div class="documentation">
<div class='full' style='background: #000'>
  <div class='row' style="margin-left:0; margin-right:0; max-width:100%">
    <div class='large-12 columns'>
      <div class='mod modBlogPost big'>
        <div class='images'>
          
        </div>
        <div class='content' style="font-size:1.2rem; max-width:80%">
          <h1>Guide: Building an API</h1>
<div id="toc" class="toc">
<div id="toctitle">Building an API</div>
<ul class="sectlevel1">
<li><a href="#implement-the-menu-microservice">Implement the Menu Microservice</a>
<ul class="sectlevel2">
<li><a href="#internal-data">Internal Data</a></li>
<li><a href="#rpc-endpoint">RPC Endpoint - /</a></li>
<li><a href="#stream-endpoint">Stream Endpoint - /</a></li>
</ul>
</li>
<li><a href="#create-the-order-microservice">Create the Order Microservice</a>
<ul class="sectlevel2">
<li><a href="#create-the-microservice">Create the Microservice</a></li>
<li><a href="#get-the-menu-data">Get the Menu Data</a></li>
<li><a href="#create-the-order-api">Create the Order API</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This guide is maintained at <a href="https://github.com/muoncore/guide" class="bare">https://github.com/muoncore/guide</a> Please submit issues at that repository.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Finish the Menu API</p>
</li>
<li>
<p>Build an Order API</p>
</li>
<li>
<p>Have it interact with the Menu API</p>
</li>
<li>
<p>Create reactive data flows between services</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This last item is important. Understanding how data should move in a Reactive system is the most important lesson when
building Microservices that will be able to tolerate network distribution and the various fun failure modes that comes with that.</p>
</div>
<div class="paragraph">
<p>Unresolved directive in index.adoc - include::guide/2-api/../12daypromo.adoc[]</p>
</div>
<div class="sect1">
<h2 id="implement-the-menu-microservice">Implement the Menu Microservice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imagine a Pie Shop (a nice one!). You have tables, people looking at the menu, nice plants in the corner, the works</p>
</div>
<div class="paragraph">
<p>This is a advanced shop, and so at each of the tables is a tablet showing the current menu.</p>
</div>
<div class="paragraph">
<p>Given the boutique nature of the shop, the Menu is constantly updated through the day as the kitchen
makes Pies and they are eaten, so reducing stock again.</p>
</div>
<div class="paragraph">
<p>The Menu needs to be able to show the various items available, their prices and be able to recieve
push updates whenever these change.</p>
</div>
<div class="paragraph">
<p>To implement these, you need to update the service you created in part one, replacing its endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get the current state as a request/ response, aka RPC. In clients, you will use this to get the initial state of the menu, and also
any time you need to ad hoc query it.</p>
</li>
<li>
<p>Have current state always be up to date. This endpoint will push updates from the Menu to subscribed clients
using the Reactive Stream protocol. This will allow you to distribute low latency updates to all clients.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will implement updating the Menu state in the next episode of the series.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Introspection</div>
<div class="paragraph">
<p>Muon is built to enable you to use multiple protocols. Given that, you are going to need a way to understand what a service is able to do for you.</p>
</div>
<div class="paragraph">
<p>Since Muon is focused on communication and data models, it&#8217;s approach is generally "the answer is a protocol, what&#8217;s the question?"</p>
</div>
<div class="paragraph">
<p>The answer in Muon is the <em>Introspection Protocol</em>. This is a simple interaction that allows you to interrogate a remote system
to see what it is capable of doing for you.</p>
</div>
<div class="paragraph">
<p>To call it via the CLI, execute <code>muon introspect [servicename]</code></p>
</div>
<div class="paragraph">
<p>This is also available in the Muon SDK apis.</p>
</div>
<div class="paragraph">
<p>Try that now on your running menu microservice to see the protocol endpoints you have already made.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="internal-data">Internal Data</h3>
<div class="paragraph">
<p>We need a menu data structure to work with, we&#8217;ll use Java classes for these in Java land.</p>
</div>
<div class="paragraph">
<p>Create a <code>MenuItem</code> class, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> pieshop<span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.*</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MenuItem</span> <span style="color: #666666">{</span>

  <span style="color: #008000; font-weight: bold">private</span> String id <span style="color: #666666">=</span> UUID<span style="color: #666666">.</span><span style="color: #7D9029">randomUUID</span><span style="color: #666666">().</span><span style="color: #7D9029">toString</span><span style="color: #666666">();</span>
  <span style="color: #008000; font-weight: bold">private</span> String name<span style="color: #666666">;</span>
  <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">double</span> price<span style="color: #666666">;</span>

  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">MenuItem</span><span style="color: #666666">(</span>String name<span style="color: #666666">,</span> <span style="color: #B00040">double</span> price<span style="color: #666666">)</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">name</span> <span style="color: #666666">=</span> name<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">price</span> <span style="color: #666666">=</span> price<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getName</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">return</span> name<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">getPrice</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">return</span> price<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>
  <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getId</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">return</span> id<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create a <code>CurrentMenu</code> class, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> pieshop<span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.List</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CurrentMenu</span> <span style="color: #666666">{</span>

  <span style="color: #008000; font-weight: bold">private</span> List<span style="color: #666666">&lt;</span>MenuItem<span style="color: #666666">&gt;</span> items<span style="color: #666666">;</span>

  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CurrentMenu</span><span style="color: #666666">(</span>List<span style="color: #666666">&lt;</span>MenuItem<span style="color: #666666">&gt;</span> items<span style="color: #666666">)</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">items</span> <span style="color: #666666">=</span> items<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">public</span> List<span style="color: #666666">&lt;</span>MenuItem<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getItems</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">return</span> items<span style="color: #666666">;</span>
  <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These will form the local state of the Menu.</p>
</div>
<div class="paragraph">
<p>Lastly, rework your <code>Menu</code> class a little to make it a little more manageable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Menu</span> <span style="color: #666666">{</span>

  <span style="color: #008000; font-weight: bold">private</span> CurrentMenu menu <span style="color: #666666">=</span> standardMenu<span style="color: #666666">();</span>

  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">Menu</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    AutoConfiguration config <span style="color: #666666">=</span>
      MuonConfigBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withServiceIdentifier</span><span style="color: #666666">(</span>
        <span style="color: #BA2121">&quot;menu&quot;</span><span style="color: #666666">).</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>

    Muon muon <span style="color: #666666">=</span> MuonBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withConfig</span><span style="color: #666666">(</span>config<span style="color: #666666">).</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>


    <span style="color: #408080; font-style: italic">// define your Muon endpoints here...</span>
  <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">private</span> CurrentMenu <span style="color: #0000FF">standardMenu</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">CurrentMenu</span><span style="color: #666666">(</span>Arrays<span style="color: #666666">.</span><span style="color: #7D9029">asList</span><span style="color: #666666">(</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MenuItem</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Pork Pie&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">2.50),</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MenuItem</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Blueberry Pie&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">2.50),</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MenuItem</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Radish Pie&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">2.50),</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MenuItem</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Apple Pie&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">2.50)</span>
    <span style="color: #666666">));</span>
  <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">main</span><span style="color: #666666">(</span>String<span style="color: #666666">[]</span> args<span style="color: #666666">)</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">Menu</span><span style="color: #666666">();</span>
  <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a representation of the Menu containing some pies. You will use this while developing
the API as a runtime stub.</p>
</div>
</div>
<div class="sect2">
<h3 id="rpc-endpoint">RPC Endpoint - /</h3>
<div class="paragraph">
<p>Now, you need to update the RPC endpoint to be able to access this data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    muon<span style="color: #666666">.</span><span style="color: #7D9029">handleRequest</span><span style="color: #666666">(</span>all<span style="color: #666666">(),</span> request <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
      request<span style="color: #666666">.</span><span style="color: #7D9029">ok</span><span style="color: #666666">(</span>menu<span style="color: #666666">);</span>
    <span style="color: #666666">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This simply passes the current menu state into the handler, where it will be serialised and sent through.</p>
</div>
<div class="paragraph">
<p>Run the service and then call it via the cli</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt;muon rpc rpc://menu

┌────────────┬───────────────────┬────────────────────────────────────────────────────────────┐
│ STATUS     │ CONTENT/TYPE      │ BODY                                                       │
├────────────┼───────────────────┼────────────────────────────────────────────────────────────┤
│ 200        │ application/json  │ {"items":[{"name":"Pork Pie","price":2.5},{"name":"Bluebe… │
└────────────┴───────────────────┴────────────────────────────────────────────────────────────┘

========= RESPONSE FULL BODY: ==================================================================

{ items:
   [ { name: 'Pork Pie', price: 2.5 },
     { name: 'Blueberry Pie', price: 2.5 },
     { name: 'Radish Pie', price: 2.5 },
     { name: 'Apple Pie', price: 2.5 } ] }</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="stream-endpoint">Stream Endpoint - /</h3>
<div class="paragraph">
<p>Next, you need to update the stream endpoint to send the state of the menu every time it is updated.</p>
</div>
<div class="paragraph">
<p>There are multiple methods for doing this, depending on which FRP library you use to implement
your service internals (Muon takes no position on what&#8217;s best in that field, only caring that
they implement Reactive Streams).</p>
</div>
<div class="paragraph">
<p>Assuming you stick with RxJava2, one way to implement this would be to push the current state into an RxJava
<code>Subject</code>.</p>
</div>
<div class="paragraph">
<p>The following code will create a new streaming endpoint that, whenever a new item of data is pushed
into the subject, distribute the Menu to all subscribers.</p>
</div>
<div class="paragraph">
<p>Since we don&#8217;t yet have a mechanism to update the menu, you can simulate it for now, using a thread
that periodically updates the state and pushes the new data out. We will fix this in the next episode</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    PublishSubject<span style="color: #666666">&lt;</span>CurrentMenu<span style="color: #666666">&gt;</span> publishSubject <span style="color: #666666">=</span> PublishSubject<span style="color: #666666">.</span><span style="color: #7D9029">create</span><span style="color: #666666">();</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    muon<span style="color: #666666">.</span><span style="color: #7D9029">publishSource</span><span style="color: #666666">(</span>
      <span style="color: #BA2121">&quot;/live&quot;</span><span style="color: #666666">,</span>                                                             <i class="conum" data-value="2"></i><b>(2)</b>
      PublisherLookup<span style="color: #666666">.</span><span style="color: #7D9029">PublisherType</span><span style="color: #666666">.</span><span style="color: #7D9029">HOT</span><span style="color: #666666">,</span>
      publishSubject<span style="color: #666666">.</span><span style="color: #7D9029">toFlowable</span><span style="color: #666666">(</span>BackpressureStrategy<span style="color: #666666">.</span><span style="color: #7D9029">BUFFER</span><span style="color: #666666">));</span>

    <span style="color: #408080; font-style: italic">//Simulate menu updates for this episode of the Guide!</span>
    <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">Thread</span><span style="color: #666666">(()</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
      <span style="color: #008000; font-weight: bold">while</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
          Thread<span style="color: #666666">.</span><span style="color: #7D9029">sleep</span><span style="color: #666666">(1000);</span>
          publishSubject<span style="color: #666666">.</span><span style="color: #7D9029">onNext</span><span style="color: #666666">(</span>menu<span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>InterruptedException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
          e<span style="color: #666666">.</span><span style="color: #7D9029">printStackTrace</span><span style="color: #666666">();</span>
        <span style="color: #666666">}</span>
      <span style="color: #666666">}</span>
    <span style="color: #666666">}).</span><span style="color: #7D9029">start</span><span style="color: #666666">();</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an RxJava <code>PublishSubject</code>. This can give us a Reactive Streams Publisher, and lets you arbitrarily push data in. There are probably better choices for most other circumstances, but for this, this is appropriate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtain a <code>Flowable</code> from RxJava and expose this on a Muon stream endpoint</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Re run the service, and now you can subscribe to this stream using the cli</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; muon stream stream://menu/live

{ items:
   [ { name: 'Pork Pie', price: 2.5 },
     { name: 'Blueberry Pie', price: 2.5 },
     { name: 'Radish Pie', price: 2.5 },
     { name: 'Apple Pie', price: 2.5 } ] }
{ items:
   [ { name: 'Pork Pie', price: 2.5 },
     { name: 'Blueberry Pie', price: 2.5 },
     { name: 'Radish Pie', price: 2.5 },
     { name: 'Apple Pie', price: 2.5 } ] }

... every second ...</pre>
</div>
</div>
<div class="paragraph">
<p>Now we have a system inside the Menu service that allows us to keep a consistent version of the menu data,
and for remote clients to both retrieve that, and also have the Menu service keep that up to date via push updates.</p>
</div>
<div class="paragraph">
<p>Next, we will build the Order service that will use this!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-order-microservice">Create the Order Microservice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next up, we want to be able to take orders.  To build this, we will use Node.js (go Polyglot!)</p>
</div>
<div class="paragraph">
<p>The API for an Order is an RPC endpoint. Take a request, process, send response back when done.</p>
</div>
<div class="paragraph">
<p>The complexity comes from the interaction between the Order and Menu services. How should we
have the communicate?</p>
</div>
<div class="paragraph">
<p>The easy way is to have Order make an RPC call to the Menu, getting the state each time. This
would add latency and some fragility to the service though. What happens if the Menu service goes down?</p>
</div>
<div class="paragraph">
<p>Here you have CAP theorum choice to make. Do you want to build a consistent, yet fragile system,
and so always check the Menu at source, or do you want to build an available system that could make the occasional
inconsistent data decision?</p>
</div>
<div class="paragraph">
<p>In our case, we will choose AP (because I always choose AP where possible, otherwise why are you building
Microservices?)</p>
</div>
<div class="paragraph">
<p>The impact on our system is that the Order service will be able to place orders while the Menu service
is down. The cost of this is that the Order service may place orders against an out of date Menu, either stock
or price. This would only be the case if the Menu service is completely unavailable.</p>
</div>
<div class="paragraph">
<p>To do this, you will subscribe to the streaming endpoint on the Menu service and effectively keep
a representation of the Menu data within the Order service. This gives us some nice advantages.
Scale will be much easier, all the data is now local, and in memory. We can rework the data structure to make
it more amenable for Order processing. If the stream connection is lost, we still have that data in memory until the Menu
service comes back up, at which point the service reconnects and gets back in sync</p>
</div>
<div class="sect2">
<h3 id="create-the-microservice">Create the Microservice</h3>
<div class="paragraph">
<p>First, install NPM and node as at <a href="http://npmjs.org" class="bare">http://npmjs.org</a></p>
</div>
<div class="paragraph">
<p>Once you have a working installation, create a new directory called 'orders' and then create a new npm project in there
using <code>npm init</code></p>
</div>
<div class="paragraph">
<p>Once you have done that, add a dependency for muon</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>npm install muon-core --save</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new file as the entry point, <code>index.js</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span style="color: #008000; font-weight: bold">var</span> Muon <span style="color: #666666">=</span> require(<span style="color: #BA2121">&quot;muon-core&quot;</span>)
<span style="color: #008000; font-weight: bold">var</span> muonurl <span style="color: #666666">=</span> process.env.MUON_URL <span style="color: #666666">||</span> <span style="color: #BA2121">&quot;amqp://muon:microservices@rabbitmq&quot;</span>

logger.info(<span style="color: #BA2121">&quot;Muon is enabled, booting up using url &quot;</span> <span style="color: #666666">+</span> muonurl)
<span style="color: #008000; font-weight: bold">var</span> muon <span style="color: #666666">=</span> Muon.create(<span style="color: #BA2121">&quot;orders&quot;</span>, muonurl); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a Muon instance using the given URL for the transport/ discovery connection. In this case, defaulting to AMQP.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run this up</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; node index.js</pre>
</div>
</div>
<div class="paragraph">
<p>It will appear in the Muon discovery information, however it has no functionality, so you can&#8217;t <em>do</em> anything with it yet.</p>
</div>
</div>
<div class="sect2">
<h3 id="get-the-menu-data">Get the Menu Data</h3>
<div class="paragraph">
<p>Before we give the Order its own API, we will get some data from the Menu and store it in the Order service. This shows Muon in use
as a client.</p>
</div>
<div class="paragraph">
<p>Start your Menu service in a different process and leave it running.</p>
</div>
<div class="paragraph">
<p>What we want to do now is to get the Menu data, and pull it into the Order service.</p>
</div>
<div class="paragraph">
<p>As we discussed above, this will allow the order service to keep on processing even when the Menu service goes down, an AP
design decision.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span style="color: #008000; font-weight: bold">var</span> currentMenu <span style="color: #666666">=</span> {}

<span style="color: #008000; font-weight: bold">function</span> connectMenu() {
  console.log(<span style="color: #BA2121">&quot;Attempting to connect to Menu live stream&quot;</span>)
  muon.subscribe(<span style="color: #BA2121">&quot;stream://menu/live&quot;</span>, {}, (menu) <span style="color: #666666">=&gt;</span> {                         
    currentMenu <span style="color: #666666">=</span> menu<i class="conum" data-value="1"></i><b>(1)</b>
    console.log(<span style="color: #BA2121">&quot;Menu Updated&quot;</span>)
  }, (error) <span style="color: #666666">=&gt;</span> {
    console.log(<span style="color: #BA2121">&quot;Disconnected from Menu service, reconnecting &quot;</span>, error)
    setTimeout(connectMenu, <span style="color: #666666">10000</span>)                                             
  }, (complete) <span style="color: #666666">=&gt;</span> {<i class="conum" data-value="2"></i><b>(2)</b>
    console.log(<span style="color: #BA2121">&quot;Stream was closed by the remote service, reconnecting ... &quot;</span>)
    setTimeout(connectMenu, <span style="color: #666666">10000</span>)
  })
}
connectMenu()</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Subscribe to the menu live data. Remember that this is pushing new updates every second</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>On an error, attempt to reconnect 10s later.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Trigger the connection/ reconnect</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now run the server again. You should see the log messages every second. Try shutting down the
Menu service, you&#8217;ll see error messages and attempts to reconnect.</p>
</div>
<div class="paragraph">
<p>Start the Menu service up again and you&#8217;ll see the subscription be re-established.</p>
</div>
<div class="paragraph">
<p>You now have menu data, held locally within the Order service, and eventually consistent with
the Menu service itself.</p>
</div>
</div>
<div class="sect2">
<h3 id="create-the-order-api">Create the Order API</h3>
<div class="paragraph">
<p>Now we have the Menu data, we can look to process orders!</p>
</div>
<div class="paragraph">
<p>This naturally fits an RPC style interaction. We will provide a single endpoint <code>/order</code> that
lets you place an order.</p>
</div>
<div class="paragraph">
<p>This will be done by submitting the following data</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json">{
  <span style="color: #008000; font-weight: bold">&quot;client&quot;</span>: <span style="color: #BA2121">&quot;David&quot;</span>                               <i class="conum" data-value="1"></i><b>(1)</b>
  <span style="color: #BA2121">&quot;items&quot;</span>: [                                      <i class="conum" data-value="2"></i><b>(2)</b>
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc7&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>},
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc8&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>},
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc9&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>},
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc1&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>}
  ]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The client who placed this order.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The items, in a list matching item id to the number required</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The response will show the full order</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json">{
  <span style="color: #008000; font-weight: bold">&quot;client&quot;</span>: <span style="color: #BA2121">&quot;David&quot;</span>
  <span style="color: #BA2121">&quot;items&quot;</span>: [
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc7&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>},
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc8&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>},
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc9&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>},
    {<span style="color: #008000; font-weight: bold">&quot;id&quot;</span>:<span style="color: #BA2121">&quot;b4690eb0-8b7f-4707-896b-e7772910fcc1&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;value&quot;</span>:<span style="color: #666666">2</span>}
  ],
  <span style="color: #008000; font-weight: bold">&quot;total&quot;</span>: <span style="color: #666666">15.99</span>                               <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The total order value</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implementing this is fairly straight forward. Create a new RPC endpoint in <code>index.js</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript">muon.handle(<span style="color: #BA2121">&quot;/order&quot;</span>, (data, response) <span style="color: #666666">=&gt;</span> {                          
<i class="conum" data-value="1"></i><b>(1)</b>
  <span style="color: #008000; font-weight: bold">var</span> orderRequest <span style="color: #666666">=</span> data.body                                       
<i class="conum" data-value="2"></i><b>(2)</b>
  <span style="color: #008000; font-weight: bold">var</span> orderResponse <span style="color: #666666">=</span> JSON.parse(JSON.stringify(orderRequest))       
<i class="conum" data-value="3"></i><b>(3)</b>
  orderResponse.total <span style="color: #666666">=</span> orderResponse.items.reduce((accum, current) <span style="color: #666666">=&gt;</span> {  
    <span style="color: #008000; font-weight: bold">var</span> item <span style="color: #666666">=</span> currentMenu.items.find((item) <span style="color: #666666">=&gt;</span> item.id <span style="color: #666666">==</span> current.id)<i class="conum" data-value="4"></i><b>(4)</b>
    <span style="color: #008000; font-weight: bold">return</span> accum <span style="color: #666666">+</span> item.price <span style="color: #666666">*</span> current.value;
  }, <span style="color: #666666">0</span>);

  response(orderResponse)
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an RPC endpoint for /order</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtain the RPC payload</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Deep clone the order.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Calculate the <code>total</code> field and add it to the response.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, you aren&#8217;t storing the Orders coming in, but you can see how we can perform
transactional processing and remain resilient in the face of a network failure.</p>
</div>
<div class="paragraph">
<p>To run this, you can use the CLI. FIrst obtain the IDs from the Menu as above, then
call Order</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; muon rpc rpc://orders/order '{"items": [{"id": "33c919e2-9291-44c6-8195-c9bbfb4517b5", "value": 5}] }'

┌────────────┬──────────────────┬────────────────────────────────────────────────────────────┐
│ STATUS     │ CONTENT/TYPE     │ BODY                                                       │
├────────────┼──────────────────┼────────────────────────────────────────────────────────────┤
│ 200        │ application/json │ {"items":[{"id":"33c919e2-9291-44c6-8195-c9bbfb4517b5","v… │
└────────────┴──────────────────┴────────────────────────────────────────────────────────────┘

========= RESPONSE FULL BODY: ==========================================

{ items: [ { id: '33c919e2-9291-44c6-8195-c9bbfb4517b5', value: 5 } ],
  total: 12.5 }</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You now have two Microservices that interact in a Reactive way, communicating via
streaming data and maintaining local data where it is needed, rather than abusing
RPC style interactions to do that.</p>
</div>
<div class="paragraph">
<p>You have seen eventual consistency, the benefits of streaming data
and how to build an AP system.</p>
</div>
<div class="paragraph">
<p>In the next episode of the series, you will add data persistence and distribution to your services in the form of
event streams using a dedicated Microservice, Photon.</p>
</div>
</div>
</div>

        </div>
      </div>

      <div class='four spacing'></div>
    </div>
  </div>
</div>
</div>

    </div>

    

  <!--End mc_embed_signup-->
<div class='full no-padding' style='background: #111'>
  <div class='two spacing'></div>
  <div class='row'>
    <div class='large-12 columns' style="color:white;">
      <p>©2017 Muon Core Ltd. All rights reserved.</p>
    </div>
  </div>
  <div class='spacing'></div>
</div>


<script src="/javascripts/jquery.countTo.js" type="text/javascript"></script>
<script src="/javascripts/jquery.appear.js" type="text/javascript"></script>
<script src="/javascripts/jquery.validate.js" type="text/javascript"></script>
<script src="/javascripts/jquery.sequence-min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75338923-1', 'auto');
  ga('require', 'linkid');
  ga('send', 'pageview');

</script>


  </body>

</html>
