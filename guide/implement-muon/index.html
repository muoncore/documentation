<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Muon - Reactive APIs</title>
  <meta name="description" content="Learn how to build a new implementation of Muon and Muon apis">

    <link rel="stylesheet" href="/css/foundation.css">

    <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <script src="/javascripts/modernizr.foundation.js" type="text/javascript"></script>
    <script src="/javascripts/jquery-2.1.0.js" type="text/javascript"></script>
    <script src="/javascripts/terrific-1.1.1.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.url.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="/javascripts/json2.js" type="text/javascript"></script>
    <script src="/javascripts/foundation.js" type="text/javascript"></script>
  <script>
    // terrificjs bootstrap
    (function($) {
        $(document).ready(function() {
            var $page = $('body');
            var config = {
              dependencyPath: {
                plugin: 'javascripts/'
              }
            }
            var application = new Tc.Application($page, config);
            application.registerModules();
            application.start();
        });
    })(Tc.$);
  </script>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,700,300" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/masonry.pkgd.js" type="text/javascript"></script>
  <script src="/javascripts/imagesloaded.pkgd.min.js" type="text/javascript"></script>
  <script src="/javascripts/slick.min.js" type="text/javascript"></script>

  <link rel="canonical" href="/guide/implement-muon/">
  <link rel="alternate" type="application/rss+xml" title="Muon - Reactive APIs" href="/feed.xml" />
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
          <link rel="stylesheet" href="/css/asciidoc.css">
          <link rel="stylesheet" href="/css/producttable.css">
                  <style>
  @media only screen and (min-width:768px){#toctitle{font-size:1.375em}
      body.toc2{padding-left:15em;padding-right:0}
#toc {margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;right:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc >ul{font-size:.9em;margin-bottom:0}
#toc ul ul{margin-left:0;padding-left:1em}
#toc ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
  @media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc {width:20em}
#toc #toctitle{font-size:1.375em}
#toc >ul{font-size:.95em}
#toc ul ul{padding-left:1.25em}
      body.toc2.toc-right{padding-left:0;padding-right:20em}}

#toc { z-index:20; padding-top:120px;}
#documentation { padding-left:10px; margin-left:auto; margin-right:auto}
#documentation .row { margin:auto }
      code {
          background:none;
          border:0;
      }

      code span { border: 0; width:100% }
      .listingblock {
         background: #eee;
         border-radius:5px;
          border:1px solid #ccc
      }
  }

  div.documentation a.btn {
    margin-top:20px;
    background: #3498db;
    background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
    background-image: -moz-linear-gradient(top, #3498db, #2980b9);
    background-image: -ms-linear-gradient(top, #3498db, #2980b9);
    background-image: -o-linear-gradient(top, #3498db, #2980b9);
    background-image: linear-gradient(to bottom, #3498db, #2980b9);
    -webkit-border-radius: 28;
    -moz-border-radius: 28;
    border-radius: 28px;
    font-family: Arial;
    color: #ffffff;
    font-size: 20px;
    padding: 10px 20px 10px 20px;
    text-decoration: none;
  }

  div.documentation a.btn:hover {
    background: #3cb0fd;
    background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
    background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
    text-decoration: none;
  }

  </style>

  <link rel="stylesheet" href="/css/sidebar2.css">
</head>


  <body>
    
      <a id='top'></a>
<div class='contain-to-grid sticky fullwidth'>
  <nav class='top-bar onepage' data-options='sticky_on: large' data-topbar=''>
    <ul class='title-area'>
      <li class='name'>
        <h1>
          <a href="/">
            <img alt="" src="/images/muonlogo.png" style="width:50px; height:50px" /> Muon
          </a>
        </h1>
      </li>
      <li class='toggle-topbar menu-icon'>
        <a href='#'>Menu</a>
      </li>
    </ul>
    <span style="float:left">Reactive APIs for Microservices, Browser and More ...</span>
    <section class='top-bar-section'>
      <ul class='right'>
        
          
            <li>
              
                <a href="guide/index.html">Guides</a>
              

            </li>
          
        
          
            <li class="has-dropdown">
              <a href="/guide/index.html">Docs</a>
              <ul class='dropdown'>
                
                  <li>
                    <a href="/guide/index.html">Guides</a>
                  </li>
                
                  <li>
                    <a href="/submodules/cli/doc/index.html">CLI</a>
                  </li>
                
                  <li>
                    <a href="/submodules/java/doc/">Java</a>
                  </li>
                
                  <li>
                    <a href="/submodules/clojure/doc/index.html">Clojure</a>
                  </li>
                
                  <li>
                    <a href="/submodules/node/doc/index.html">Node.JS</a>
                  </li>
                
                  <li>
                    <a href="/submodules/muonjs/doc/index.html">Browser</a>
                  </li>
                
                  <li>
                    <a href="/submodules/photon/doc/index.html">Photon - Event Store</a>
                  </li>
                
              </ul>
            </li>
          
        
          
            <li>
              
                <a href="https://github.com/muoncore">Github</a>
              

            </li>
          
        
      </ul>
    </section>
  </nav>
</div>
<div class='full no-padding'>
  <!-- Begin MailChimp Signup Form -->
  <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
         We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
  </style>
  <div id="mc_embed_signup">
    <form action="//simplicityitself.us9.list-manage.com/subscribe/post?u=fce1e12e8f44592cf75288e11&amp;id=98e2ce96d8" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Get updated on new releases and features</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_fce1e12e8f44592cf75288e11_98e2ce96d8" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
      </div>
    </form>
  </div>
</div>

    

    <div id='main' role='main'>
      <div class="documentation">
<div class='full' style='background: #000'>
  <div class='row' style="margin-left:0; margin-right:0; max-width:100%">
    <div class='large-12 columns'>
      <div class='mod modBlogPost big'>
        <div class='images'>
          
        </div>
        <div class='content' style="font-size:1.2rem; max-width:80%">
          <div id="toc" class="toc">
<div id="toctitle">Implement Muon</div>
<ul class="sectlevel1">
<li><a href="#terms-and-visualisations">Terms and visualisations</a></li>
<li><a href="#message-formats-and-core-protocols">Message formats and core protocols</a>
<ul class="sectlevel2">
<li><a href="#example-protocol-messages-rpc">Example protocol messages. RPC.</a></li>
<li><a href="#transport-messages">Transport messages</a></li>
</ul>
</li>
<li><a href="#implementation-guide">Implementation guide</a></li>
<li><a href="#client-components">Client Components</a>
<ul class="sectlevel2">
<li><a href="#channel-and-message-dispatch">Channel and message dispatch</a></li>
<li><a href="#codecs">Codecs</a></li>
<li><a href="#transport-interface">Transport interface</a></li>
<li><a href="#discovery">Discovery</a></li>
<li><a href="#transport-client">Transport client</a>
<ul class="sectlevel3">
<li><a href="#shared-channel-multiplex-optional">Shared channel/ multiplex (optional)</a></li>
<li><a href="#load-balancing-optional">Load Balancing (optional)</a></li>
</ul>
</li>
<li><a href="#implement-the-api-type">Implement the API type</a></li>
</ul>
</li>
<li><a href="#server-components">Server Components</a>
<ul class="sectlevel2">
<li><a href="#server-stacks">Server Stacks</a></li>
<li><a href="#discovery-2">Discovery</a></li>
<li><a href="#server-side-api">Server side api</a></li>
<li><a href="#shared-channel-multiplex-required">Shared channel/ multiplex (required)</a></li>
</ul>
</li>
<li><a href="#implementing-an-api-type">Implementing an API type</a></li>
<li><a href="#introspection-api">Introspection api</a></li>
</ul>
</div>
<div class="paragraph">
<p>Muon is a toolkit for building Reactive/ message based apis. Thia article describes how to implement Muon, including discussing the core Muon model, message formats and rationale for the major design decisions.</p>
</div>
<div class="paragraph">
<p>Being an api approach, Muon is defined ultimately by the messages that are exchanged between services and the order they are exchanged in. Message definitions and interaction protocols described in this document are mandatory for implementing Muon correctly.</p>
</div>
<div class="sect1">
<h2 id="terms-and-visualisations">Terms and visualisations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Muon model is a restricted form of Communicating Sequential Processes  (CSP). This places the channel as the primary design primitive in this system.</p>
</div>
<div class="paragraph">
<p>Muon is therefore implemented as a set of components, connected by <em>bi directional channels</em>, that we refer to as a <em>bichannel</em>. Some of these are purely in memory, and act to be an async transform and dispatch, other channels bridge a network, and are implemented by <strong><em>Transports</em></strong>.  In order to visualise this and be able to understand and communicate about it more easily, we have adopted a common visualisation metaphor that we use in diagrams, and in code.</p>
</div>
<div class="paragraph">
<p>Here is an example.</p>
</div>
<div class="paragraph">
<p>todo. example.</p>
</div>
<div class="paragraph">
<p>Here, you can see the various components and channels arranged horizontally and connected on their left/ right sides to others. These are the terms that we use, <em>left</em> and <em>right</em>. When you see these in code, or as part of a design document, it is always referring to this visual arrangement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="message-formats-and-core-protocols">Message formats and core protocols</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Muon operates in layers. It&#8217;s messaging formats represent that explicitly. As is common in layered network models, Muon systems create a mirrored stack of message protocols. Each adds capabilities to the one to its right, providing services for the one to its left.</p>
</div>
<div class="paragraph">
<p>It is expected that each layer in the stack of channel/ agents will interact with its equivalent in the mirror stack in the "other" Muon instance(s)</p>
</div>
<div class="paragraph">
<p>You can see that in this example.</p>
</div>
<div class="paragraph">
<p>todo, diagram of client/ server above each other.</p>
</div>
<div class="paragraph">
<p>Each type of API that is implemented in a Muon system will be implemented as its own messaging protocol, interacting with other instances of that protocol by using the mid level "Muon protocol" and lower level transports.</p>
</div>
<div class="paragraph">
<p>As such, the mid layer is common across all apis and transports, which we refer to as Muon Messages. This an example message, represented as JSON (which is not the only transport representation)</p>
</div>
<div class="paragraph">
<p>todo. a muon message.</p>
</div>
<div class="paragraph">
<p>This schema is used by all protocols. the role of the Muon protocol is to create and consume Muon Messages appropriately. The protocol will encode its data into the muon message payload field and indicate where in the protocol state machine it is by using the <em>step</em> field.</p>
</div>
<div class="paragraph">
<p>How the messages are used by them higher protocols is not restricted.</p>
</div>
<div class="paragraph">
<p>This is designed to be very flexible, and allow encoding of arbitrary payloads from higher level protocols without caring what is within them.</p>
</div>
<div class="sect2">
<h3 id="example-protocol-messages-rpc">Example protocol messages. RPC.</h3>
<div class="paragraph">
<p>The apis have their own messages that they must encode and decode into Muon Messages. These are not restricted in any way, and once encoded into the muon message payload, is ignored by all other Muon components.</p>
</div>
<div class="paragraph">
<p>To give a worked example. Simple rpc (this is not the actual rpc protocol)</p>
</div>
<div class="paragraph">
<p>The app code will make a request, somehow. The client protocol will generate a message to represent that request. It could look like this (as JSON).</p>
</div>
<div class="paragraph">
<p>todo exanple request.</p>
</div>
<div class="paragraph">
<p>It will then encode that and generate a Muon message holding that, and indicating the protocol step.</p>
</div>
<div class="paragraph">
<p>The Muon message would look like this.</p>
</div>
<div class="paragraph">
<p>TODO, a Request message</p>
</div>
<div class="paragraph">
<p>Then, the api opens a new channel to the remote service and sends the message.</p>
</div>
<div class="paragraph">
<p>On the server side in the remote service, Muon understands the protocol that has been requested and begins a new protocol session (assuming it supports the given protocol!)</p>
</div>
<div class="paragraph">
<p>The server side rpc protocol will receive the Muon message above, and will then decode the payload. Based on the content, it can use whatever api it has available to do some work  (e.g. call a function). Once complete, it will generate a response message, encode and wrap that into a muon message. The messages would look like this.</p>
</div>
<div class="paragraph">
<p>todo.  response messages</p>
</div>
<div class="paragraph">
<p>Once done, it can close the channel. The client receives the message, unpacks it and completes its work.</p>
</div>
<div class="paragraph">
<p>RPC is a very simple protocol, but I hope you can see how more complex protocols can be designed and built easily using this approach.</p>
</div>
</div>
<div class="sect2">
<h3 id="transport-messages">Transport messages</h3>
<div class="paragraph">
<p>Transports deal with moving muon messages from one service to another. They operate within their own discrete layer and are undefined from the point of view of the higher layers.</p>
</div>
<div class="paragraph">
<p>The flow for a transport message interaction is</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Muon Client protocol calls "open a channel to service X".</p>
</li>
<li>
<p>This invokes on the transport, with the <code>protocol</code> and <code>service name</code>.</p>
</li>
<li>
<p>The client side transport looks up the concrete connection information from the local discovery</p>
</li>
<li>
<p>The client side transport connects to its server side peer of the remote service and negotiates a new channel connection for the given protocol.</p>
</li>
<li>
<p>The server side transport negotiates with its client counterpart and looks up in the local list of server protocols to see if it has that protocol registered. If so, its opens a local channel to it and connects it to the network channel that the client opened.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the end of this process, the transports have negotiated a channel and created server side resources to handle the given protocol request. From this point on</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="implementation-guide">Implementation guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The client and server portions of Muon are fairly distinct, and can be implemented independently. If you are implementing a new Muon, it is recommended you pick one of these and fully implement it before moving to the other. This guide assumes you will implement the client, along with common components, first.</p>
</div>
<div class="paragraph">
<p>The following component design is recommended, but is not required to implement Muon correctly. The only requirement for building a conformant muon implementation is to follow the message protocols and message schemas.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="client-components">Client Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The client portion of Muon has the responsibility for</p>
</div>
<div class="sect2">
<h3 id="channel-and-message-dispatch">Channel and message dispatch</h3>

</div>
<div class="sect2">
<h3 id="codecs">Codecs</h3>

</div>
<div class="sect2">
<h3 id="transport-interface">Transport interface</h3>

</div>
<div class="sect2">
<h3 id="discovery">Discovery</h3>

</div>
<div class="sect2">
<h3 id="transport-client">Transport client</h3>
<div class="sect3">
<h4 id="shared-channel-multiplex-optional">Shared channel/ multiplex (optional)</h4>

</div>
<div class="sect3">
<h4 id="load-balancing-optional">Load Balancing (optional)</h4>

</div>
</div>
<div class="sect2">
<h3 id="implement-the-api-type">Implement the API type</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="server-components">Server Components</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="server-stacks">Server Stacks</h3>

</div>
<div class="sect2">
<h3 id="discovery-2">Discovery</h3>

</div>
<div class="sect2">
<h3 id="server-side-api">Server side api</h3>

</div>
<div class="sect2">
<h3 id="shared-channel-multiplex-required">Shared channel/ multiplex (required)</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="implementing-an-api-type">Implementing an API type</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="introspection-api">Introspection api</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have finished all aspects of this guide, you will have a fully working Muon. Unfortunately, it won&#8217;t actually do that much!  For it to be useful, you have to implement one of the api protocols on top of it. For the server side, you should have a minimal introspection all at the very least. Introspection is a <strong>required</strong> API, and all Muon server implementations must have a basic introspection capability at the very least.</p>
</div>
<div class="paragraph">
<p>Each Muon api is very different in the way it operates, but they all share common defining features. They all connect to one or more other Muon service, by opening channels to them, and then exchange messages according to their own internally defined messaging protocol.  In order to implement an existing api, you need to understand its messaging protocol and data schemas. Then, you can implement the protocol, and design a user facing api that is idiomatic in your runtime.</p>
</div>
</div>
</div>
        </div>
      </div>

      <div class='four spacing'></div>
    </div>
  </div>
</div>
</div>

    </div>

    

  <!--End mc_embed_signup-->
<div class='full no-padding' style='background: #111'>
  <div class='two spacing'></div>
  <div class='row'>
    <div class='large-12 columns' style="color:white;">
      <p>Â©2017 Muon Core Ltd. All rights reserved.</p>
    </div>
  </div>
  <div class='spacing'></div>
</div>


<script src="/javascripts/jquery.countTo.js" type="text/javascript"></script>
<script src="/javascripts/jquery.appear.js" type="text/javascript"></script>
<script src="/javascripts/jquery.validate.js" type="text/javascript"></script>
<script src="/javascripts/jquery.sequence-min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75338923-1', 'auto');
  ga('require', 'linkid');
  ga('send', 'pageview');

</script>


  </body>

</html>
