<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Muon - Reactive APIs</title>
  <meta name="description" content="">

    <link rel="stylesheet" href="/css/foundation.css">

    <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <script src="/javascripts/modernizr.foundation.js" type="text/javascript"></script>
    <script src="/javascripts/jquery-2.1.0.js" type="text/javascript"></script>
    <script src="/javascripts/terrific-1.1.1.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.url.js" type="text/javascript"></script>
    <script src="/javascripts/jquery.cookie.js" type="text/javascript"></script>
    <script src="/javascripts/json2.js" type="text/javascript"></script>
    <script src="/javascripts/foundation.js" type="text/javascript"></script>
  <script>
    // terrificjs bootstrap
    (function($) {
        $(document).ready(function() {
            var $page = $('body');
            var config = {
              dependencyPath: {
                plugin: 'javascripts/'
              }
            }
            var application = new Tc.Application($page, config);
            application.registerModules();
            application.start();
        });
    })(Tc.$);
  </script>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,700,300" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/masonry.pkgd.js" type="text/javascript"></script>
  <script src="/javascripts/imagesloaded.pkgd.min.js" type="text/javascript"></script>
  <script src="/javascripts/slick.min.js" type="text/javascript"></script>

  <link rel="canonical" href="/submodules/java/doc/">
  <link rel="alternate" type="application/rss+xml" title="Muon - Reactive APIs" href="/feed.xml" />
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
          <link rel="stylesheet" href="/css/asciidoc.css">
          <link rel="stylesheet" href="/css/producttable.css">
                  <style>
  @media only screen and (min-width:768px){#toctitle{font-size:1.375em}
      body.toc2{padding-left:15em;padding-right:0}
#toc {margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;right:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc >ul{font-size:.9em;margin-bottom:0}
#toc ul ul{margin-left:0;padding-left:1em}
#toc ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
  @media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc {width:20em}
#toc #toctitle{font-size:1.375em}
#toc >ul{font-size:.95em}
#toc ul ul{padding-left:1.25em}
      body.toc2.toc-right{padding-left:0;padding-right:20em}}

#toc { z-index:20; padding-top:120px;}
#documentation { padding-left:10px; margin-left:auto; margin-right:auto}
#documentation .row { margin:auto }
      code {
          background:none;
          border:0;
      }

      code span { border: 0; width:100% }
      .listingblock {
         background: #eee;
         border-radius:5px;
          border:1px solid #ccc
      }
  }

  div.documentation a.btn {
    margin-top:20px;
    background: #3498db;
    background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
    background-image: -moz-linear-gradient(top, #3498db, #2980b9);
    background-image: -ms-linear-gradient(top, #3498db, #2980b9);
    background-image: -o-linear-gradient(top, #3498db, #2980b9);
    background-image: linear-gradient(to bottom, #3498db, #2980b9);
    -webkit-border-radius: 28;
    -moz-border-radius: 28;
    border-radius: 28px;
    font-family: Arial;
    color: #ffffff;
    font-size: 20px;
    padding: 10px 20px 10px 20px;
    text-decoration: none;
  }

  div.documentation a.btn:hover {
    background: #3cb0fd;
    background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
    background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
    background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
    text-decoration: none;
  }

  </style>

  <link rel="stylesheet" href="/css/sidebar2.css">
</head>


  <body>
    
      <a id='top'></a>
<div class='contain-to-grid sticky fullwidth'>
  <nav class='top-bar onepage' data-options='sticky_on: large' data-topbar=''>
    <ul class='title-area'>
      <li class='name'>
        <h1>
          <a href="/">
            <img alt="" src="/images/muonlogo.png" style="width:50px; height:50px" /> Muon
          </a>
        </h1>
      </li>
      <li class='toggle-topbar menu-icon'>
        <a href='#'>Menu</a>
      </li>
    </ul>
    <span style="float:left">Reactive APIs for Microservices, Browser and More ...</span>
    <section class='top-bar-section'>
      <ul class='right'>
        
          
            <li>
              
                <a href="guide/index.html">Guides</a>
              

            </li>
          
        
          
            <li class="has-dropdown">
              <a href="/guide/index.html">Docs</a>
              <ul class='dropdown'>
                
                  <li>
                    <a href="/guide/index.html">Guides</a>
                  </li>
                
                  <li>
                    <a href="/submodules/cli/doc/index.html">CLI</a>
                  </li>
                
                  <li>
                    <a href="/submodules/java/doc/">Java</a>
                  </li>
                
                  <li>
                    <a href="/submodules/clojure/doc/index.html">Clojure</a>
                  </li>
                
                  <li>
                    <a href="/submodules/node/doc/index.html">Node.JS</a>
                  </li>
                
                  <li>
                    <a href="/submodules/muonjs/doc/index.html">Browser</a>
                  </li>
                
                  <li>
                    <a href="/submodules/photon/doc/index.html">Photon - Event Store</a>
                  </li>
                
              </ul>
            </li>
          
        
          
            <li>
              
                <a href="https://github.com/muoncore">Github</a>
              

            </li>
          
        
      </ul>
    </section>
  </nav>
</div>
<div class='full no-padding'>
  <!-- Begin MailChimp Signup Form -->
  <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
         We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
  </style>
  <div id="mc_embed_signup">
    <form action="//simplicityitself.us9.list-manage.com/subscribe/post?u=fce1e12e8f44592cf75288e11&amp;id=98e2ce96d8" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Get updated on new releases and features</label>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_fce1e12e8f44592cf75288e11_98e2ce96d8" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
      </div>
    </form>
  </div>
</div>

    

    <div id='main' role='main'>
      <div class="documentation">
<div class='full' style='background: #000'>
  <div class='row' style="margin-left:0; margin-right:0; max-width:100%">
    <div class='large-12 columns'>
      <div class='mod modBlogPost big'>
        <div class='images'>
          
        </div>
        <div class='content' style="font-size:1.2rem; max-width:80%">
          <div id="toc" class="toc">
<div id="toctitle">Muon Java</div>
<ul class="sectlevel1">
<li><a href="#muon-java">Muon Java</a>
<ul class="sectlevel2">
<li><a href="#a-microservice-based-system-in-5-minutes">A Microservice based system in 5 minutes</a></li>
<li><a href="#of-apis-and-protocols">Of APIs and Protocols</a>
<ul class="sectlevel3">
<li><a href="#example-protocols">Example Protocols</a>
<ul class="sectlevel4">
<li><a href="#rpc">RPC</a>
<ul class="sectlevel5">
<li><a href="#simple-rpc">Simple RPC</a></li>
<li><a href="#making-it-reactive">Making it Reactive</a></li>
</ul>
</li>
<li><a href="#reactive-streams">Reactive Streams</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#transports">Transports</a>
<ul class="sectlevel3">
<li><a href="#initialising-transports">Initialising Transports</a></li>
<li><a href="#multiple-transports">Multiple Transports</a></li>
<li><a href="#muonmessages">MuonMessages</a></li>
</ul>
</li>
<li><a href="#discovery">Discovery</a>
<ul class="sectlevel3">
<li><a href="#initialising-discoveries">Initialising Discoveries</a>
<ul class="sectlevel4">
<li><a href="#multiple-discoveries">Multiple Discoveries</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#advanced-features">Advanced Features</a>
<ul class="sectlevel3">
<li><a href="#wiretap">Wiretap</a></li>
<li><a href="#encoding-support">Encoding Support</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="paragraph">
<p>The current version is 7.4.0</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This document is maintained at <a href="https://github.com/muoncore/muon-java" class="bare">https://github.com/muoncore/muon-java</a>.
Please submit issues at that repository.
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="muon-java">Muon Java</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Muon Java is the implementation of the Muon microservices toolkit, for the Java platform. Muon enables you to easily build
microservices in many languages that have richer, more performant and fully reactive communication semantics and gain access
to Muon compatible services written in other languages without having to sacrifice the rich semantics or performance.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Contributing</div>
<div class="paragraph">
<p>Muon and the ecosystem services are open source.
Contribute to Muon Java and this documentation at <a href="http://github.com/muoncore/muon-java" class="bare">http://github.com/muoncore/muon-java</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="a-microservice-based-system-in-5-minutes">A Microservice based system in 5 minutes</h3>
<div class="paragraph">
<p>The quickest way to start a new Muon Java Microservice is to clone the example
repo at <a href="https://github.com/muoncore/muon-java-gradle-example" class="bare">https://github.com/muoncore/muon-java-gradle-example</a></p>
</div>
<div class="paragraph">
<p>This is set up to use Gradle as the build tool and Java as the application
language.</p>
</div>
<div class="paragraph">
<p>First, install the Muon CLI, then clone this repository.</p>
</div>
<div class="paragraph">
<p>This project has an example service already in there that looks similar to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MuonServerExample</span> <span style="color: #666666">{</span>

  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">main</span><span style="color: #666666">(</span>String<span style="color: #666666">[]</span> args<span style="color: #666666">)</span> <span style="color: #666666">{</span>

    AutoConfiguration config <span style="color: #666666">=</span> MuonConfigBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withServiceIdentifier</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;my-test-service&quot;</span><span style="color: #666666">)</span>               <i class="conum" data-value="1"></i><b>(1)</b>
      <span style="color: #666666">.</span><span style="color: #7D9029">addWriter</span><span style="color: #666666">(</span>conf <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;muon.discovery.factories&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;io.muoncore.discovery.amqp.AmqpDiscoveryFactory&quot;</span><span style="color: #666666">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;amqp.discovery.url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;amqp://muon:microservices@localhost&quot;</span><span style="color: #666666">);</span>

        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;muon.transport.factories&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;io.muoncore.transport.amqp.AmqpMuonTransportFactory&quot;</span><span style="color: #666666">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;amqp.transport.url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;amqp://muon:microservices@localhost&quot;</span><span style="color: #666666">);</span>

      <span style="color: #666666">})</span>
      <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>

    Muon muon <span style="color: #666666">=</span> MuonBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withConfig</span><span style="color: #666666">(</span>config<span style="color: #666666">).</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>              <i class="conum" data-value="4"></i><b>(4)</b>

    RpcServer rpc <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">RpcServer</span><span style="color: #666666">(</span>muon<span style="color: #666666">);</span>                             <i class="conum" data-value="5"></i><b>(5)</b>

    rpc<span style="color: #666666">.</span><span style="color: #7D9029">handleRequest</span><span style="color: #666666">(</span>path<span style="color: #666666">(</span><span style="color: #BA2121">&quot;/&quot;</span><span style="color: #666666">))</span>                                     <i class="conum" data-value="6"></i><b>(6)</b>
      <span style="color: #666666">.</span><span style="color: #7D9029">addResponseType</span><span style="color: #666666">(</span>Map<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span>
      <span style="color: #666666">.</span><span style="color: #7D9029">handler</span><span style="color: #666666">(</span>request <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
        request<span style="color: #666666">.</span><span style="color: #7D9029">ok</span><span style="color: #666666">(</span>Collections<span style="color: #666666">.</span><span style="color: #7D9029">singletonMap</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;message&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;hello world&quot;</span><span style="color: #666666">));</span>  <i class="conum" data-value="7"></i><b>(7)</b>
      <span style="color: #666666">});</span>
  <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a muon configuration using a fluent interface builder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the AMQP transport to connect to the correct broker (see transport, below)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the AMQP discovery to connect to the correct broker (see discovery, below)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create a Muon instance on the AMQP transport/ discovery</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Add an RPC Server to this Muon instance                       (see protocols, below)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Add an RPC endpoint to the server</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>When invoked, respond to the RPC request with some manufactured data.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run this from a prebuilt Gradle task</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">&gt; ./gradlew runServer</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then use the Muon CLI to interact with the new service, using the name <code>example-service</code> set above as it&#8217;s identifier</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">&gt; muon rpc example-service /</code></pre>
</div>
</div>
<div class="paragraph">
<p>This accesses the <code>rpc</code> protocol and interacts with the <code>/</code> endpoint</p>
</div>
<div class="paragraph">
<p>You will see the results from the example service that should look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">david@patmos:~/<span style="color: #19177C">$ </span>muon rpc rpc://example-service/hello

┌────────────┬──────────────────────────────┬───────────────────────────────────────────────┐
│ STATUS     │ CONTENT/TYPE                 │ BODY                                          │
├────────────┼──────────────────────────────┼───────────────────────────────────────────────┤
│ <span style="color: #666666">200</span>        │ application/json             │ <span style="color: #666666">{</span><span style="color: #BA2121">&quot;Hello&quot;</span>:<span style="color: #BA2121">&quot;world 1481639846708&quot;</span><span style="color: #666666">}</span>               │
└────────────┴──────────────────────────────┴───────────────────────────────────────────────┘

<span style="color: #666666">=========</span> RESPONSE FULL BODY: <span style="color: #666666">========================================================</span>

<span style="color: #666666">{</span> Hello: <span style="color: #BA2121">&#39;world 1481639846708&#39;</span> <span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations, you have a running Muon service!</p>
</div>
</div>
<div class="sect2">
<h3 id="of-apis-and-protocols">Of APIs and Protocols</h3>
<div class="paragraph">
<p>Muon, at heart, is a toolkit for building new <em>Reactive APIs</em>. These are message based and give the ability to build true APIs that confirm to the guiding principles of the Reactive Manifesto.</p>
</div>
<div class="paragraph">
<p>To get you started, Muon provides a set of prebuilt types of API that give you semantics beyond HTTP or other RPCish protocols</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reactive Streams. Managed Streaming, with explicit client controlled back-pressure. Follows the Reactive Streams semantics and in Muon Java, fully supports the interfaces. - <a href="https://github.com/muoncore/stack-reactive-streams" class="bare">https://github.com/muoncore/stack-reactive-streams</a></p>
</li>
<li>
<p>Extended RPC - <a href="http://github.com/muoncore/stack-rpc" class="bare">http://github.com/muoncore/stack-rpc</a></p>
</li>
<li>
<p>Persisted Event Logs - <a href="http://github.com/muoncore/stack-event" class="bare">http://github.com/muoncore/stack-event</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once you have constructed a Muon instance, connected it to a Discovery and enabled some transport, you can begin to wrap it with Protocols. This give different types of behaviour, richer semantics.</p>
</div>
<div class="paragraph">
<p>In addition to the ones described here, you can write your own!</p>
</div>
<div class="sect3">
<h4 id="example-protocols">Example Protocols</h4>
<div class="paragraph">
<p>Here we look at RPC and Reactive Streams. These are hosted at  <a href="http://github.com/muoncore/stack-rpc" class="bare">http://github.com/muoncore/stack-rpc</a> and <a href="http://github.com/muoncore/stack-reactive-streams" class="bare">http://github.com/muoncore/stack-reactive-streams</a></p>
</div>
<div class="paragraph">
<p>You will find the Java implementations alongside implementations for other Muon implementations of those API types.</p>
</div>
<div class="sect4">
<h5 id="rpc">RPC</h5>
<div class="paragraph">
<p>Request/ Response is a well understood communication style where you make a single request and expect to receive a single response</p>
</div>
<div class="paragraph">
<p>Muon supports this style of communication, over it&#8217;s naturally scalable reactive and event based channel communication.</p>
</div>
<div class="sect5">
<h6 id="simple-rpc">Simple RPC</h6>
<div class="paragraph">
<p>Here is the simplest possible Muon RPC endpoint. It accepts any data pushed to it, and responds with a simple text message</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">server</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> ExecutionException<span style="color: #666666">,</span> InterruptedException <span style="color: #666666">{</span>
  RpcServer rpcServer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">RpcServer</span><span style="color: #666666">(</span>muon<span style="color: #666666">);</span>

  <span style="color: #408080; font-style: italic">//request handler</span>
  rpcServer<span style="color: #666666">.</span><span style="color: #7D9029">handleRequest</span><span style="color: #666666">(</span>HandlerPredicates<span style="color: #666666">.</span><span style="color: #7D9029">all</span><span style="color: #666666">(),</span> request <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
    request<span style="color: #666666">.</span><span style="color: #7D9029">ok</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Hi There&quot;</span><span style="color: #666666">);</span>
  <span style="color: #666666">});</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The client for this looks like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">client</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> ExecutionException<span style="color: #666666">,</span> InterruptedException <span style="color: #666666">{</span>
  RpcClient rpcClient <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">RpcClient</span><span style="color: #666666">(</span>muon<span style="color: #666666">);</span>

  Response data <span style="color: #666666">=</span> rpcClient<span style="color: #666666">.</span><span style="color: #7D9029">request</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;request://myservice/&quot;</span><span style="color: #666666">).</span><span style="color: #7D9029">get</span><span style="color: #666666">();</span>
  System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;The Data is &quot;</span> <span style="color: #666666">+</span> data<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">));</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Response object contains meta data about the response, eg, if it succeeded.</p>
</div>
</div>
<div class="sect5">
<h6 id="making-it-reactive">Making it Reactive</h6>
<div class="paragraph">
<p>The handler does not need to response synchronously as in the above example. The response can be invoked from any context, and by any thread.</p>
</div>
<div class="paragraph">
<p>This will cause an event to flow back down the channel and complete the request/ response cycle.</p>
</div>
<div class="paragraph">
<p>An example of this in action is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">RpcServer rpcServer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">RpcServer</span><span style="color: #666666">(</span>muon<span style="color: #666666">);</span>

Queue<span style="color: #666666">&lt;</span>RequestWrapper<span style="color: #666666">&gt;</span> requestQueue <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> LinkedList<span style="color: #666666">&lt;&gt;();</span>

rpcServer<span style="color: #666666">.</span><span style="color: #7D9029">handleRequest</span><span style="color: #666666">(</span>all<span style="color: #666666">(),</span> <span style="color: #A0A000">requestQueue:</span><span style="color: #666666">:</span>add<span style="color: #666666">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>

<span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">Thread</span><span style="color: #666666">(()</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>   <i class="conum" data-value="2"></i><b>(2)</b>

  <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>

    RequestWrapper wrapper <span style="color: #666666">=</span> requestQueue<span style="color: #666666">.</span><span style="color: #7D9029">poll</span><span style="color: #666666">();</span>

    wrapper<span style="color: #666666">.</span><span style="color: #7D9029">ok</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Hello&quot;</span><span style="color: #666666">);</span>       <i class="conum" data-value="3"></i><b>(3)</b>

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>requestQueue<span style="color: #666666">.</span><span style="color: #7D9029">isEmpty</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
      <span style="color: #408080; font-style: italic">// ... wait ....</span>
    <span style="color: #666666">}</span>
  <span style="color: #666666">}</span>
  <i class="conum" data-value="4"></i><b>(4)</b>
<span style="color: #666666">});</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As requests arrive, add them to a Queue for processing</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start a thread to process the requests in serial</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Send a response. This is on a different thread</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Original thread drops out of this method and is re-used by Muon</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This demonstrates adding the requests onto a queue and processing them asynchronously.</p>
</div>
<div class="paragraph">
<p>Be aware that the request will time out on both the client and server side, depending on your configuration.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="reactive-streams">Reactive Streams</h5>
<div class="paragraph">
<p>Muon is built to enable the creation of streams easily. Internally everything is treated as a <em>channel</em>, a naturally streaming
construction.</p>
</div>
<div class="paragraph">
<p>This is best accessed via the Reactive Streams API, a cross industry effort to standardise streaming communication with back pressure.</p>
</div>
<div class="paragraph">
<p>To publish a new stream, create a <em>Publisher</em> and pass it into the publishStream method, giving it a name, and the semantics of the stream.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">server</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> ExecutionException<span style="color: #666666">,</span> InterruptedException <span style="color: #666666">{</span>
  ReactiveStreamServer rxServer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">ReactiveStreamServer</span><span style="color: #666666">(</span>muon<span style="color: #666666">);</span>                  <i class="conum" data-value="1"></i><b>(1)</b>

  rxServer<span style="color: #666666">.</span><span style="color: #7D9029">publishSource</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;/counter&quot;</span><span style="color: #666666">,</span> COLD<span style="color: #666666">,</span> Flowable<span style="color: #666666">.</span><span style="color: #7D9029">range</span><span style="color: #666666">(5,</span> <span style="color: #666666">10));</span> <i class="conum" data-value="2"></i><b>(2)</b>

  rxServer<span style="color: #666666">.</span><span style="color: #7D9029">publishGeneratedSource</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;/dynamic-counter&quot;</span><span style="color: #666666">,</span> COLD<span style="color: #666666">,</span> subscriptionRequest <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>         <i class="conum" data-value="3"></i><b>(3)</b>

    <span style="color: #B00040">int</span> start <span style="color: #666666">=</span> Integer<span style="color: #666666">.</span><span style="color: #7D9029">parseInt</span><span style="color: #666666">(</span>subscriptionRequest<span style="color: #666666">.</span><span style="color: #7D9029">getArgs</span><span style="color: #666666">().</span><span style="color: #7D9029">getOrDefault</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;counter&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;5&quot;</span><span style="color: #666666">));</span> <i class="conum" data-value="4"></i><b>(4)</b>

    <span style="color: #008000; font-weight: bold">return</span> Flowable<span style="color: #666666">.</span><span style="color: #7D9029">range</span><span style="color: #666666">(</span>start<span style="color: #666666">,</span> start <span style="color: #666666">+</span> <span style="color: #666666">100);</span>        <i class="conum" data-value="5"></i><b>(5)</b>
  <span style="color: #666666">});</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the ReactiveStreamServer. The protocol is then attached to the running Muon instance and will be visible in the introspection report.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a re-usable new RxJava Flowable (which implements <code>Publisher</code>) and expose it on a Muon endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>DYnamically generate a <code>Publisher</code>. Parameters can be passed to the endpoint by the client, which allows the endpoint to load data, transform the stream or other tasks before providing the Publisher to be connected to by the remote Subscriber</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Access the passed params</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Dynamically build a new <code>Publisher</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here, we use <em>RxJava</em> to demonstrate the creation of a Publisher, however any Reactive Streams compatible framework or library could be used.</p>
</div>
<div class="paragraph">
<p>To access the data from another service, use the subscribe method, passing in the logical Muon discovery url.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">client</span><span style="color: #666666">(</span>Muon muon<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> URISyntaxException <span style="color: #666666">{</span>
  ReactiveStreamClient rxClient <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">ReactiveStreamClient</span><span style="color: #666666">(</span>muon<span style="color: #666666">);</span>

  rxClient<span style="color: #666666">.</span><span style="color: #7D9029">subscribe</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">URI</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;stream://my-server/counter&quot;</span><span style="color: #666666">),</span> <span style="color: #008000; font-weight: bold">new</span> Subscriber<span style="color: #666666">&lt;</span>StreamData<span style="color: #666666">&gt;()</span> <span style="color: #666666">{</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onSubscribe</span><span style="color: #666666">(</span>Subscription s<span style="color: #666666">)</span> <span style="color: #666666">{</span>
      s<span style="color: #666666">.</span><span style="color: #7D9029">request</span><span style="color: #666666">(</span>Long<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">);</span>                <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onNext</span><span style="color: #666666">(</span>StreamData streamData<span style="color: #666666">)</span> <span style="color: #666666">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
      Map payload <span style="color: #666666">=</span> streamData<span style="color: #666666">.</span><span style="color: #7D9029">getPayload</span><span style="color: #666666">(</span>Map<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

      <span style="color: #408080; font-style: italic">//do something with the data ..</span>
      System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span>payload<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onError</span><span style="color: #666666">(</span>Throwable t<span style="color: #666666">)</span> <span style="color: #666666">{</span>
      t<span style="color: #666666">.</span><span style="color: #7D9029">printStackTrace</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onComplete</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
      <span style="color: #408080; font-style: italic">// stream is done. clean up resources.</span>
    <span style="color: #666666">}</span>
  <span style="color: #666666">});</span>

  rxClient<span style="color: #666666">.</span><span style="color: #7D9029">subscribe</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">URI</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;stream://my-server/dynamic-counter?counter=30&quot;</span><span style="color: #666666">),</span>   <i class="conum" data-value="4"></i><b>(4)</b>
    subscriber
  <span style="color: #666666">);</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Subscribe to the given Rx endpoint. Pass in a Reactive Streams <code>Subscriber</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Manage back pressure from the client. Here, we just request as much data as possible.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Receive the data. <code>StreamData</code> lets you selectively decode it in various ways to allow heterogeneous data flow over the stream and be correctly decoded.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Subscribe to a dynamic endpoint, passing a parameter in the query string.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again, this example uses Java and shows two separate services communicating using a reactive message stream, with back pressure support managed by the Reactive Stream Subscriber.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transports">Transports</h3>
<div class="paragraph">
<p>Muon services connect with others to do their work, ordinarily, across a network.  The core concept in Muon systems is the <em>channel</em>, a bi-directional message pipe. If you dig into protocols, you will see many of these bichannels being constructed and attached together. One of these bichannels will be obtained from a <code>MuonTransport</code>, which represents a network communication.</p>
</div>
<div class="paragraph">
<p>As with protocols, transport come in two parts.  The <code>MuonTransport</code> interface represents the client side of the transport, and is responsible for connecting to some remote service on demand and transferring messages back/ forth.</p>
</div>
<div class="paragraph">
<p>The server side of the transport is wholly internal to the transport, and will, in some way, accept connections from another Muon instance and then request an internal bichannel from the <code>ServerStacks</code> interface.  This interface facades over the server side of the API types. When creating a Muon server protocol (eg, <code>ReactiveStreamServer</code>), you are providing a source of bichannels for the <code>ServerStacks</code> implementation to give to transports.</p>
</div>
<div class="paragraph">
<p>So long as you can implement the interface <code>ChannelConnection</code> with <code>MuonMessage</code> flowing through it, you can build a transport for Muon.</p>
</div>
<div class="sect3">
<h4 id="initialising-transports">Initialising Transports</h4>
<div class="paragraph">
<p>The most common way of initialising transports is to use <code>MuonConfigBuilder</code> and pass in the transport factories to use. These will use the properties that are set in the config to construct the appropriate factories and register them with the Muon instance.</p>
</div>
<div class="paragraph">
<p>For example, this service configures the AMQP transport and instructs it to connect to a particular broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    AutoConfiguration config <span style="color: #666666">=</span> MuonConfigBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withServiceIdentifier</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;my-test-service&quot;</span><span style="color: #666666">)</span>               <i class="conum" data-value="1"></i><b>(1)</b>
      <span style="color: #666666">.</span><span style="color: #7D9029">addWriter</span><span style="color: #666666">(</span>conf <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;muon.discovery.factories&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;io.muoncore.discovery.amqp.AmqpDiscoveryFactory&quot;</span><span style="color: #666666">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;amqp.discovery.url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;amqp://muon:microservices@localhost&quot;</span><span style="color: #666666">);</span>

        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;muon.transport.factories&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;io.muoncore.transport.amqp.AmqpMuonTransportFactory&quot;</span><span style="color: #666666">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;amqp.transport.url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;amqp://muon:microservices@localhost&quot;</span><span style="color: #666666">);</span>

      <span style="color: #666666">})</span>
      <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can manually construct the Muon instance to programmatically configure the transport, although you also have to programmatically configure the Discovery and Codecs as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    EventBus bus <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">EventBus</span><span style="color: #666666">();</span>

    AutoConfiguration config <span style="color: #666666">=</span> MuonConfigBuilder
           <span style="color: #666666">.</span><span style="color: #7D9029">withServiceIdentifier</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;my-test-service&quot;</span><span style="color: #666666">).</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>   <i class="conum" data-value="1"></i><b>(1)</b>

    Muon muon <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MultiTransportMuon</span><span style="color: #666666">(</span>                         <i class="conum" data-value="2"></i><b>(2)</b>
      config<span style="color: #666666">,</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">InMemDiscovery</span><span style="color: #666666">(),</span>
      Collections<span style="color: #666666">.</span><span style="color: #7D9029">singletonList</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">InMemTransport</span><span style="color: #666666">(</span>config<span style="color: #666666">,</span> bus<span style="color: #666666">)),</span>  <i class="conum" data-value="3"></i><b>(3)</b>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">JsonOnlyCodecs</span><span style="color: #666666">());</span>

    Muon muondisco <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MultiTransportMuon</span><span style="color: #666666">(</span>                         <i class="conum" data-value="1"></i><b>(1)</b>
      config<span style="color: #666666">,</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MultiDiscovery</span><span style="color: #666666">(</span>Collections<span style="color: #666666">.</span><span style="color: #7D9029">singletonList</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">InMemDiscovery</span><span style="color: #666666">())),</span> <i class="conum" data-value="2"></i><b>(2)</b>
      Collections<span style="color: #666666">.</span><span style="color: #7D9029">singletonList</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">InMemTransport</span><span style="color: #666666">(</span>config<span style="color: #666666">,</span> bus<span style="color: #666666">)),</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">JsonOnlyCodecs</span><span style="color: #666666">());</span>
  <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multiple-transports">Multiple Transports</h4>
<div class="paragraph">
<p>Muon Java supports multiple transports at the same time, and will select the best transport to use based on the order of the transport connection urls in the discovery packet (use <code>muon d --raw</code> to see this info from the CLI)</p>
</div>
</div>
<div class="sect3">
<h4 id="muonmessages">MuonMessages</h4>
<div class="paragraph">
<p>In commmon with other network models, Muon operates in levels. Each level conceptually speaks to its peer in the other service and implements this by interacting with the level below it.</p>
</div>
<div class="paragraph">
<p>In Muon, each protocol speaks to its other side implementation by interacting with a set of channels, ultimately rooted in a transport channel. The interface between "protocol channels" and the Transport channel passes a message with a well defined schema, represented in Muon Java as <code>MuonMessage</code>.  The transports job is to send and receive these messages across a network. How it does this doesn&#8217;t matter as far as the rest of Muon is concerned.</p>
</div>
<div class="paragraph">
<p>The minimal MuonMessage schema looks like this</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message ID Used for correlation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">created</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the message was created</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">target_service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The logical service name this message is heading for</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">target_service_instance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The instance of the target service this is heading to, if applicable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">origin_service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The logical service that created this message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The protocol this message was created by</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used by protocols, most commonly to indicate a message type or protocol state machine transition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used by some protocols to indicate error states, deprecated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">content_type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The content type of the payload, eg "application/json"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">channel_op</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicate if the message should be considered a terminator, ie dispatch then shut down the channel</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payload</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte[]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The payload of the message, encoded as a byte array.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Messages flowing between services are fully symmetrical, all flow using this common schema. Transports are permitted to trim this information for performance once a channel has been established, so long as it is inferred and reconstructed on the receiving side.</p>
</div>
<div class="paragraph">
<p>To give better usability when constructing channels, Muon Java uses the extended generic types <code>MuonInboundMessage</code> and <code>MuonOutboundMessage</code>. Protocols will construct <code>MuonOutboundMessage</code> instances as needed and consume <code>MuonOutboundMessage</code> instances.</p>
</div>
<div class="paragraph">
<p>If you wish to construct a new transport, you will be transporting these messages.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="discovery">Discovery</h3>
<div class="paragraph">
<p>Muon services connect with others to do their work, ordinarily, across a network.  To do this, services need to be able to find each other. Muon takes the position that hardcoding a network address, port or name is a terrible idea. Specifically, Muon supports transport across a network both directly, point to point, and via intermediaries, such as a broker or message router (eg, the muonjs websocket gateway).</p>
</div>
<div class="paragraph">
<p>This means that all service names must be logical, and so must be dynamically resolvable by services. Muon also takes the general position that fully consistent views of the surrounding system are expensive to produce and maintain, and are often wrong anyway.</p>
</div>
<div class="paragraph">
<p>There is a common subsystem in all Muon implementations handling discovery. Similar to Transports, Muon Discoveries define a portable data schema that is used to describe services enough to be able to select the appropriate transport to use to connect to it.</p>
</div>
<div class="sect3">
<h4 id="initialising-discoveries">Initialising Discoveries</h4>
<div class="paragraph">
<p>The most common way of initialising discoveries is to use <code>MuonConfigBuilder</code> and pass in the transport factories to use. These will use the properties that are set in the config to construct the appropriate factories and register them with the Muon instance.</p>
</div>
<div class="paragraph">
<p>For example, this service configures the AMQP transport and instructs it to connect to a particular broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    AutoConfiguration config <span style="color: #666666">=</span> MuonConfigBuilder<span style="color: #666666">.</span><span style="color: #7D9029">withServiceIdentifier</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;my-test-service&quot;</span><span style="color: #666666">)</span>               <i class="conum" data-value="1"></i><b>(1)</b>
      <span style="color: #666666">.</span><span style="color: #7D9029">addWriter</span><span style="color: #666666">(</span>conf <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;muon.discovery.factories&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;io.muoncore.discovery.amqp.AmqpDiscoveryFactory&quot;</span><span style="color: #666666">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;amqp.discovery.url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;amqp://muon:microservices@localhost&quot;</span><span style="color: #666666">);</span>

        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;muon.transport.factories&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;io.muoncore.transport.amqp.AmqpMuonTransportFactory&quot;</span><span style="color: #666666">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        conf<span style="color: #666666">.</span><span style="color: #7D9029">getProperties</span><span style="color: #666666">().</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;amqp.transport.url&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;amqp://muon:microservices@localhost&quot;</span><span style="color: #666666">);</span>

      <span style="color: #666666">})</span>
      <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can manually construct the Muon instance to programmatically configure the discovery, although you also have to programmatically configure the Transports and Codecs as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">    Muon muondisco <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MultiTransportMuon</span><span style="color: #666666">(</span>                         <i class="conum" data-value="1"></i><b>(1)</b>
      config<span style="color: #666666">,</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">MultiDiscovery</span><span style="color: #666666">(</span>Collections<span style="color: #666666">.</span><span style="color: #7D9029">singletonList</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">InMemDiscovery</span><span style="color: #666666">())),</span> <i class="conum" data-value="2"></i><b>(2)</b>
      Collections<span style="color: #666666">.</span><span style="color: #7D9029">singletonList</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">InMemTransport</span><span style="color: #666666">(</span>config<span style="color: #666666">,</span> bus<span style="color: #666666">)),</span>
      <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">JsonOnlyCodecs</span><span style="color: #666666">());</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>programatically initialise a Muon instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>MultiDiscovery</code> to combine discovery information. In this case, from InMemDiscovery only.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="multiple-discoveries">Multiple Discoveries</h5>
<div class="paragraph">
<p>Muon Java supports multiple discoveries at the same time. All of them are active and provide information on how to locate a service. If multiple discoveries are active at once, their information is merged to give a comprehensive view.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-features">Advanced Features</h3>
<div class="sect3">
<h4 id="wiretap">Wiretap</h4>
<div class="paragraph">
<p>The transport subsystem of Muon injects a WiretapChannel into every connection that is made. This allows you to optionally
read the messages moving in and out of the transport and further interpret them. The messages themselves are immutable,
and so you recieve the message itself for processing.</p>
</div>
<div class="paragraph">
<p>Ordinarily, this is used to record the way a service communicates with the rest of the distributed application. This
is particularly useful when designing and building a new communication protocol.</p>
</div>
<div class="paragraph">
<p>Image a service with a single RPC endpoint that accepts an undefined object data structure, which represent using a Map.
 It then responds inline wth the number 42. A very simple service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">rpc<span style="color: #666666">.</span><span style="color: #7D9029">handleRequest</span><span style="color: #666666">(</span>all<span style="color: #666666">(),</span> request <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
  request<span style="color: #666666">.</span><span style="color: #7D9029">ok</span><span style="color: #666666">(42);</span>
<span style="color: #666666">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to generate a list of all the services that are calling this one, without altering the business method.</p>
</div>
<div class="paragraph">
<p>We could implement this using a wiretap, this will extract a stream of all the requests that match a particular filter.
The stream interface provided implements the Reactive Stream interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">Set<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;</span> remoteServices <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> HashSet<span style="color: #666666">&lt;&gt;();</span>     <i class="conum" data-value="1"></i><b>(1)</b>
Subscriber<span style="color: #666666">&lt;</span>MuonMessage<span style="color: #666666">&gt;</span> sub <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Subscriber<span style="color: #666666">&lt;</span>MuonMessage<span style="color: #666666">&gt;()</span> <span style="color: #666666">{</span>
  <span style="color: #AA22FF">@Override</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onSubscribe</span><span style="color: #666666">(</span>Subscription s<span style="color: #666666">)</span> <span style="color: #666666">{</span> s<span style="color: #666666">.</span><span style="color: #7D9029">request</span><span style="color: #666666">(</span>Long<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">);</span> <span style="color: #666666">}</span>

  <span style="color: #AA22FF">@Override</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onNext</span><span style="color: #666666">(</span>MuonMessage msg<span style="color: #666666">)</span> <span style="color: #666666">{</span>
    remoteServices<span style="color: #666666">.</span><span style="color: #7D9029">add</span><span style="color: #666666">(</span>msg<span style="color: #666666">.</span><span style="color: #7D9029">getSourceServiceName</span><span style="color: #666666">());</span>  <i class="conum" data-value="2"></i><b>(2)</b>
  <span style="color: #666666">}</span>

  <span style="color: #AA22FF">@Override</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onError</span><span style="color: #666666">(</span>Throwable t<span style="color: #666666">)</span> <span style="color: #666666">{</span>

  <span style="color: #666666">}</span>

  <span style="color: #AA22FF">@Override</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onComplete</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

  <span style="color: #666666">}</span>
<span style="color: #666666">};</span>

muon<span style="color: #666666">.</span><span style="color: #7D9029">getTransportControl</span><span style="color: #666666">().</span><span style="color: #7D9029">tap</span><span style="color: #666666">(</span>                      <i class="conum" data-value="3"></i><b>(3)</b>
  msg <span style="color: #666666">-&gt;</span>
    msg<span style="color: #666666">.</span><span style="color: #7D9029">getStep</span><span style="color: #666666">().</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>REQUEST<span style="color: #666666">))</span>                   <i class="conum" data-value="4"></i><b>(4)</b>
  <span style="color: #666666">.</span><span style="color: #7D9029">subscribe</span><span style="color: #666666">(</span>sub<span style="color: #666666">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The services that have connected to this one via the RPC endpont.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A Reactive Streams <code>Subscriber</code>, converting the messages into the list of origin service names</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Adding the tap into the Muon transport subsystem</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The filter matches for the <code>step</code> field on the <code>MuonMessage</code>, picking out particular message types for processing.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whenever you then perform an RPC communication, the Request <code><code>TransportMessage</code></code> events will be selected by your wiretap
 and passed into the Subscriber, in this case the Rx Subscriber.</p>
</div>
</div>
<div class="sect3">
<h4 id="encoding-support">Encoding Support</h4>
<div class="paragraph">
<p>To go across a network, all payloads used in Muon protocols ultimately need to be converted to arrays of bytes.</p>
</div>
<div class="paragraph">
<p>Muon can uses a variety of encoding methods, depending on your configuration and the types that you want to use.</p>
</div>
<div class="paragraph">
<p>The default codec in Muon Java for internal types is now <strong>Avro</strong>, and it is recommended that you use Avro if you can, as this gives an improved experience for integration with external tooling, as Muon can negotiate the sending of Avro schemas and provides them to clients via the Introspection protocol.</p>
</div>
<div class="paragraph">
<p>There are different sources of Avro Schema information that Muon can use :-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You generate a SpecificRecord extending class from an existing Schema, using the Avro tools.</p>
</li>
<li>
<p>For regular POJOS with no more information, Muon will auto create a schema from your Java type and send that. This does not include any validation rules, and auto generates the Schema types from the Java types, which may be incorrect. All fields are marked as Nullable</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The fallback Codec is JSON, encoded using GSON. This is used when no other codec can be negotiated, such as for Muon Node/ MuonJS</p>
</div>
<div class="paragraph">
<p>For Muon implementations that don&#8217;t support Avro, Muon will send JSON encoded messages and process the responses from JSON into Java types.</p>
</div>
</div>
</div>
</div>
</div>
        </div>
      </div>

      <div class='four spacing'></div>
    </div>
  </div>
</div>
</div>

    </div>

    

  <!--End mc_embed_signup-->
<div class='full no-padding' style='background: #111'>
  <div class='two spacing'></div>
  <div class='row'>
    <div class='large-12 columns' style="color:white;">
      <p>©2017 Muon Core Ltd. All rights reserved.</p>
    </div>
  </div>
  <div class='spacing'></div>
</div>


<script src="/javascripts/jquery.countTo.js" type="text/javascript"></script>
<script src="/javascripts/jquery.appear.js" type="text/javascript"></script>
<script src="/javascripts/jquery.validate.js" type="text/javascript"></script>
<script src="/javascripts/jquery.sequence-min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/javascripts/app.js" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75338923-1', 'auto');
  ga('require', 'linkid');
  ga('send', 'pageview');

</script>


  </body>

</html>
